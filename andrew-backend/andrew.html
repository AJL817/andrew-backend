<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Andrew Investment System</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --bg: #0a0b0f; --surface: #12131a; --surface2: #1a1b24;
    --border: #1e2030; --text: #e8e9f0; --dim: #6b7094; --muted: #4a4d6a;
    --accent: #c9a55a; --accent-dim: rgba(201,165,90,0.15);
    --green: #22c55e; --green-dim: rgba(34,197,94,0.12);
    --red: #ef4444; --red-dim: rgba(239,68,68,0.12);
    --blue: #3b82f6; --blue-dim: rgba(59,130,246,0.12);
    --orange: #f59e0b; --orange-dim: rgba(245,158,11,0.12);
  }
  body { background: var(--bg); color: var(--text); font-family: 'Pretendard', -apple-system, sans-serif; display: flex; min-height: 100vh; }

  /* ì‚¬ì´ë“œë°” */
  #sidebar { width: 220px; min-height: 100vh; background: var(--surface); border-right: 1px solid var(--border); padding: 20px 12px; display: flex; flex-direction: column; position: fixed; }
  .logo { padding: 0 8px; margin-bottom: 24px; }
  .logo h1 { font-size: 22px; font-weight: 800; color: var(--accent); letter-spacing: -0.5px; }
  .logo p { font-size: 8px; color: var(--muted); letter-spacing: 3px; margin-top: 2px; }
  .status { display: flex; align-items: center; gap: 6px; margin-top: 8px; }
  .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--orange); }
  .status-dot.online { background: var(--green); box-shadow: 0 0 8px rgba(34,197,94,0.4); }
  .status-dot.offline { background: var(--red); }
  .status span { font-size: 10px; color: var(--muted); }
  nav { display: flex; flex-direction: column; gap: 3px; flex: 1; }
  .nav-btn { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-family: inherit; text-align: left; background: transparent; color: var(--dim); transition: all 0.15s; }
  .nav-btn.active { background: var(--accent-dim); color: var(--accent); font-weight: 600; }
  .nav-btn:hover { background: var(--surface2); }
  .nav-icon { font-size: 14px; width: 20px; text-align: center; }
  .sidebar-footer { padding: 12px 8px; border-top: 1px solid var(--border); font-size: 10px; color: var(--muted); }

  /* ë©”ì¸ */
  #main { flex: 1; margin-left: 220px; display: flex; flex-direction: column; }
  #topbar { height: 52px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
  #topbar span { font-size: 12px; color: var(--dim); }
  #content { flex: 1; padding: 24px; overflow-y: auto; }

  /* íƒ­ íŒ¨ë„ */
  .tab-panel { display: none; }
  .tab-panel.active { display: flex; flex-direction: column; gap: 20px; }

  /* ì¹´ë“œ */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 18px; }
  .card-title { font-size: 12px; color: var(--muted); margin-bottom: 10px; }

  /* ë°°ì§€ */
  .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; letter-spacing: 0.5px; }
  .badge-high { color: var(--red); background: var(--red-dim); }
  .badge-mid { color: var(--orange); background: var(--orange-dim); }
  .badge-normal { color: var(--muted); background: var(--surface2); }
  .badge-company { color: var(--blue); background: var(--blue-dim); }

  /* í•„í„° */
  .filters { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  .filter-btn { padding: 5px 14px; border-radius: 20px; border: 1px solid var(--border); cursor: pointer; font-size: 12px; font-weight: 600; font-family: inherit; background: var(--surface); color: var(--dim); transition: all 0.15s; }
  .filter-btn.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }
  select { background: var(--surface); border: 1px solid var(--border); color: var(--text); border-radius: 6px; padding: 6px 10px; font-size: 12px; font-family: inherit; cursor: pointer; }
  .btn { padding: 6px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 600; font-family: inherit; background: var(--accent-dim); color: var(--accent); }
  .btn-primary { background: var(--accent); color: var(--bg); }

  /* ê³µì‹œ ë¦¬ìŠ¤íŠ¸ */
  .disclosure-item { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.15s; text-decoration: none; }
  .disclosure-item:hover { border-color: var(--accent); background: var(--accent-dim); }
  .disclosure-title { flex: 1; font-size: 13px; color: var(--text); }
  .disclosure-date { font-size: 11px; color: var(--muted); white-space: nowrap; }
  .disclosure-link { font-size: 11px; color: var(--accent); }

  /* ìŠ¤í”¼ë„ˆ */
  .spinner { display: flex; align-items: center; gap: 8px; color: var(--muted); font-size: 13px; padding: 20px; }
  .spin { width: 14px; height: 14px; border: 2px solid var(--border); border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ì—ëŸ¬ */
  .error-box { background: var(--red-dim); border: 1px solid var(--red); border-radius: 8px; padding: 14px; }
  .error-box p { font-size: 13px; color: var(--red); }
  .error-box small { font-size: 11px; color: var(--dim); margin-top: 4px; display: block; }

  /* ê·¸ë¦¬ë“œ */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }

  /* í…Œì´ë¸” */
  table { width: 100%; border-collapse: collapse; }
  th { padding: 12px 14px; font-size: 10px; font-weight: 600; color: var(--muted); text-align: left; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
  td { padding: 12px 14px; border-bottom: 1px solid var(--border); font-size: 13px; }
  tr:hover td { background: var(--surface2); }

  /* ìŠ¤ì½”ì–´ë°” */
  .score-wrap { display: flex; align-items: center; gap: 8px; }
  .score-bar { flex: 1; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .score-fill { height: 100%; border-radius: 2px; }
  .score-num { font-size: 12px; font-weight: 700; min-width: 28px; text-align: right; }

  /* AI ì±„íŒ… */
  #chat-messages { display: flex; flex-direction: column; gap: 12px; max-height: 420px; overflow-y: auto; padding-right: 4px; margin-bottom: 14px; }
  .msg { padding: 12px 16px; border-radius: 14px; font-size: 13px; line-height: 1.7; white-space: pre-wrap; max-width: 85%; }
  .msg-user { align-self: flex-end; background: var(--accent); color: var(--bg); border-radius: 14px 14px 4px 14px; }
  .msg-ai { align-self: flex-start; background: var(--surface); border: 1px solid var(--border); border-radius: 14px 14px 14px 4px; }
  .msg-system { background: var(--surface2); font-size: 11px; color: var(--dim); max-width: 100%; border-radius: 8px; }
  .chat-input { display: flex; gap: 8px; padding: 12px; background: var(--surface); border-radius: 12px; border: 1px solid var(--border); }
  .chat-input input { flex: 1; background: transparent; border: none; outline: none; color: var(--text); font-size: 13px; font-family: inherit; }

  /* ë¯¸ì¥ */
  .phase-enter { color: var(--green); background: var(--green-dim); }
  .phase-hold { color: var(--blue); background: var(--blue-dim); }
  .phase-caution { color: var(--orange); background: var(--orange-dim); }
</style>
</head>
<body>

<!-- ì‚¬ì´ë“œë°” -->
<div id="sidebar">
  <div class="logo">
    <h1>ANDREW</h1>
    <p>INVESTMENT SYSTEM</p>
    <div class="status">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">ì—°ê²° í™•ì¸ì¤‘...</span>
    </div>
  </div>
  <nav>
    <button class="nav-btn active" onclick="showTab('dashboard')" id="nav-dashboard"><span class="nav-icon">â—‰</span>ëŒ€ì‹œë³´ë“œ</button>
    <button class="nav-btn" onclick="showTab('kr')" id="nav-kr"><span class="nav-icon">ğŸ‡°ğŸ‡·</span>êµ­ì¥</button>
    <button class="nav-btn" onclick="showTab('us')" id="nav-us"><span class="nav-icon">ğŸ‡ºğŸ‡¸</span>ë¯¸ì¥</button>
    <button class="nav-btn" onclick="showTab('bonds')" id="nav-bonds"><span class="nav-icon">â—†</span>ì±„ê¶ŒÂ·ì›ìì¬</button>
    <button class="nav-btn" onclick="showTab('journal')" id="nav-journal"><span class="nav-icon">âœ</span>íˆ¬ì ì¼ì§€</button>
    <button class="nav-btn" onclick="showTab('ai')" id="nav-ai"><span class="nav-icon">â¬¡</span>AI ë¶„ì„</button>
  </nav>
  <div class="sidebar-footer">Draft 3.0 Â· DART ì‹¤ì‹œê°„ ì—°ë™</div>
</div>

<!-- ë©”ì¸ -->
<div id="main">
  <div id="topbar">
    <span id="dateStr"></span>
    <span id="timeStr"></span>
  </div>
  <div id="content">

    <!-- ëŒ€ì‹œë³´ë“œ íƒ­ -->
    <div class="tab-panel active" id="tab-dashboard">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <h2 style="font-size:16px;font-weight:700;">ğŸ“‹ DART ì „ìê³µì‹œ ì‹¤ì‹œê°„</h2>
          <p id="lastUpdated" style="font-size:11px;color:var(--muted);margin-top:4px;"></p>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <select id="daysSelect" onchange="fetchDart()">
            <option value="3">ìµœê·¼ 3ì¼</option>
            <option value="7" selected>ìµœê·¼ 7ì¼</option>
            <option value="14">ìµœê·¼ 14ì¼</option>
            <option value="30">ìµœê·¼ 30ì¼</option>
          </select>
          <button class="btn" onclick="fetchDart()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>
      <div class="filters" id="companyFilters"></div>
      <div id="dartContainer"><div class="spinner"><div class="spin"></div>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
      <div class="grid-2">
        <div class="card">
          <div class="card-title">ì‹œì¥ ì‹¬ë¦¬ ê²Œì´ì§€</div>
          <canvas id="gaugeCanvas" width="200" height="110"></canvas>
          <p style="font-size:11px;color:var(--dim);text-align:center;margin-top:8px;font-style:italic;">í•˜ì›Œë“œ ë§‰ìŠ¤: "ì§€ê¸ˆì€ ë§¤ìˆ˜ ê¸°íšŒ êµ¬ê°„"</p>
        </div>
        <div class="card">
          <div class="card-title">ì˜¤ëŠ˜ì˜ ì›ì¹™</div>
          <p style="font-size:12px;color:var(--accent);line-height:1.7;font-style:italic;">"ë§¤ìˆ˜ ì „ ë°˜ë“œì‹œ ë°˜ë¡ ì„ ë¨¼ì € ì¨ë³¸ë‹¤ â€” ë‚´ê°€ ì™œ í‹€ë¦´ ìˆ˜ ìˆëŠ”ê°€?"</p>
          <p style="font-size:10px;color:var(--muted);margin-top:6px;">â€” ì¹´ë„ˆë¨¼ í–‰ë™ê²½ì œí•™ ì›ì¹™</p>
        </div>
      </div>
    </div>

    <!-- êµ­ì¥ íƒ­ -->
    <div class="tab-panel" id="tab-kr">
      <div>
        <h2 style="font-size:16px;font-weight:700;">ğŸ‡°ğŸ‡· êµ­ì¥ ìŠ¤í¬ë¦¬ë„ˆ</h2>
        <p style="font-size:11px;color:var(--muted);margin-top:4px;">ROE â‰¥ 15% Â· PBR ì—…ì¢… ì´í•˜ Â· ë³¼ë¦°ì € ë°´ë“œ íƒ€ì´ë°</p>
      </div>
      <div class="card" style="padding:0;overflow:hidden;">
        <table>
          <thead><tr><th>ì¢…ëª©</th><th>ROE</th><th>PBR</th><th>EV/EBIT</th><th>ë¶€ì±„</th><th>í•´ì</th><th>ë””ìŠ¤ì¹´ìš´íŠ¸</th><th>BB</th><th>ì ìˆ˜</th></tr></thead>
          <tbody id="krTable"></tbody>
        </table>
      </div>
    </div>

    <!-- ë¯¸ì¥ íƒ­ -->
    <div class="tab-panel" id="tab-us">
      <h2 style="font-size:16px;font-weight:700;">ğŸ‡ºğŸ‡¸ ë¯¸ì¥ ìŠ¤í¬ë¦¬ë„ˆ</h2>
      <div class="card" style="padding:0;overflow:hidden;">
        <table>
          <thead><tr><th>ì¢…ëª©</th><th>ROIC</th><th>PEG</th><th>í•´ì</th><th>ì ìˆ˜</th><th>íŒë‹¨</th></tr></thead>
          <tbody id="usTable"></tbody>
        </table>
      </div>
    </div>

    <!-- ì±„ê¶Œ íƒ­ -->
    <div class="tab-panel" id="tab-bonds">
      <h2 style="font-size:16px;font-weight:700;">â—† ì±„ê¶Œ Â· ì›ìì¬</h2>
      <div id="bondsContainer"></div>
    </div>

    <!-- íˆ¬ì ì¼ì§€ íƒ­ -->
    <div class="tab-panel" id="tab-journal">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2 style="font-size:16px;font-weight:700;">âœ íˆ¬ì ì¼ì§€</h2>
        <button class="btn btn-primary">+ ìƒˆ ê¸°ë¡</button>
      </div>
      <div id="journalContainer"></div>
    </div>

    <!-- AI íƒ­ -->
    <div class="tab-panel" id="tab-ai">
      <h2 style="font-size:16px;font-weight:700;">â¬¡ AI ì¢…ëª© ë¶„ì„</h2>
      <div class="card">
        <div id="chat-messages">
          <div class="msg msg-system">ANDREW AI â€” Draft 3.0 íˆ¬ì ì² í•™ + ì‹¤ì œ DART ë°ì´í„° ê¸°ë°˜ ë¶„ì„. ì¢…ëª©, ê³µì‹œ í•´ì„, ë§¤í¬ë¡œ ì§ˆë¬¸ì„ í•´ë³´ì„¸ìš”.</div>
        </div>
        <div class="chat-input">
          <input id="chatInput" placeholder="ì¢…ëª©, ê³µì‹œ, ë§¤í¬ë¡œ ì§ˆë¬¸..." onkeydown="if(event.key==='Enter')sendChat()">
          <button class="btn btn-primary" onclick="sendChat()">ì „ì†¡</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
const BACKEND = "https://andrew-backend-production.up.railway.app";
let dartData = [], activeFilter = "ì „ì²´", chatLoading = false;

// â”€â”€ ì‹œê°„ â”€â”€
function updateTime() {
  const now = new Date();
  document.getElementById("dateStr").textContent = now.toLocaleDateString("ko-KR", { year:"numeric", month:"long", day:"numeric", weekday:"long" });
  document.getElementById("timeStr").textContent = now.toLocaleTimeString("ko-KR");
}
setInterval(updateTime, 1000); updateTime();

// â”€â”€ ë°±ì—”ë“œ ìƒíƒœ â”€â”€
async function checkBackend() {
  try {
    const r = await fetch(`${BACKEND}/`);
    if (r.ok) {
      document.getElementById("statusDot").className = "status-dot online";
      document.getElementById("statusText").textContent = "ë°±ì—”ë“œ ì—°ê²°ë¨";
    }
  } catch {
    document.getElementById("statusDot").className = "status-dot offline";
    document.getElementById("statusText").textContent = "ë°±ì—”ë“œ ì˜¤í”„ë¼ì¸";
  }
}
checkBackend();

// â”€â”€ íƒ­ ì „í™˜ â”€â”€
function showTab(id) {
  document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
  document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
  document.getElementById("tab-" + id).classList.add("active");
  document.getElementById("nav-" + id).classList.add("active");
  if (id === "dashboard") fetchDart();
  if (id === "kr") renderKR();
  if (id === "us") renderUS();
  if (id === "bonds") renderBonds();
  if (id === "journal") renderJournal();
}

// â”€â”€ DART â”€â”€
async function fetchDart() {
  const days = document.getElementById("daysSelect").value;
  document.getElementById("dartContainer").innerHTML = '<div class="spinner"><div class="spin"></div>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  try {
    const r = await fetch(`${BACKEND}/dart/recent?days=${days}`);
    const json = await r.json();
    dartData = json.data || [];
    document.getElementById("lastUpdated").textContent = "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: " + new Date().toLocaleTimeString("ko-KR");
    renderFilters();
    renderDart();
    drawGauge(32, "ê³µí¬");
  } catch(e) {
    document.getElementById("dartContainer").innerHTML = `
      <div class="error-box">
        <p>âš ï¸ ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨</p>
        <small>ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”: ${BACKEND}</small>
      </div>`;
  }
}

function renderFilters() {
  const companies = ["ì „ì²´", ...new Set(dartData.map(d => d.company))];
  document.getElementById("companyFilters").innerHTML = companies.map(c =>
    `<button class="filter-btn ${c === activeFilter ? 'active' : ''}" onclick="setFilter('${c}')">${c}</button>`
  ).join("");
}

function setFilter(c) {
  activeFilter = c;
  renderFilters();
  renderDart();
}

function renderDart() {
  const filtered = activeFilter === "ì „ì²´" ? dartData : dartData.filter(d => d.company === activeFilter);
  if (!filtered.length) {
    document.getElementById("dartContainer").innerHTML = '<div class="card"><p style="color:var(--muted);font-size:13px;">ê³µì‹œ ì—†ìŒ</p></div>';
    return;
  }
  const formatDate = d => d ? `${d.slice(0,4)}.${d.slice(4,6)}.${d.slice(6,8)}` : "";
  document.getElementById("dartContainer").innerHTML = `
    <p style="font-size:12px;color:var(--muted);margin-bottom:8px;">ì´ <span style="color:var(--accent);font-weight:700;">${filtered.length}ê±´</span> ê³µì‹œ</p>
    <div style="display:flex;flex-direction:column;gap:8px;">
      ${filtered.map(d => `
        <a class="disclosure-item" href="${d.url}" target="_blank">
          <span class="badge badge-${d.type}">${d.type === 'high' ? 'ì¤‘ìš”' : d.type === 'mid' ? 'ì£¼ëª©' : 'ì¼ë°˜'}</span>
          <span class="badge badge-company">${d.company}</span>
          <span class="disclosure-title">${d.title}</span>
          <span class="disclosure-date">${formatDate(d.date)}</span>
          <span class="disclosure-link">â†—</span>
        </a>`).join("")}
    </div>`;
}

// â”€â”€ ê²Œì´ì§€ â”€â”€
function drawGauge(val, label) {
  const c = document.getElementById("gaugeCanvas");
  if (!c) return;
  const ctx = c.getContext("2d");
  const cx = 100, cy = 85, r = 65;
  ctx.clearRect(0, 0, 200, 110);
  const grad = ctx.createLinearGradient(cx-r, 0, cx+r, 0);
  grad.addColorStop(0, "#22c55e"); grad.addColorStop(0.5, "#f59e0b"); grad.addColorStop(1, "#ef4444");
  ctx.beginPath(); ctx.arc(cx, cy, r, Math.PI, 0); ctx.strokeStyle = "#1e2030"; ctx.lineWidth = 10; ctx.stroke();
  ctx.beginPath(); ctx.arc(cx, cy, r, Math.PI, Math.PI + (val/100)*Math.PI); ctx.strokeStyle = grad; ctx.lineWidth = 10; ctx.stroke();
  const ang = Math.PI + (val/100)*Math.PI;
  const color = val < 30 ? "#22c55e" : val < 50 ? "#f59e0b" : "#ef4444";
  ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx+(r-15)*Math.cos(ang), cy+(r-15)*Math.sin(ang)); ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.stroke();
  ctx.fillStyle = color; ctx.font = "bold 20px sans-serif"; ctx.textAlign = "center"; ctx.fillText(val, cx, cy+20);
  ctx.fillStyle = "#6b7094"; ctx.font = "11px sans-serif"; ctx.fillText(label, cx, cy+36);
}

// â”€â”€ êµ­ì¥ â”€â”€
const KR_DATA = [
  { ticker:"005930", name:"ì‚¼ì„±ì „ì", roe:18.2, pbr:1.1, evEbit:8.3, debt:32, moat:"ì›ê°€ìš°ìœ„", discount:"âœ“ ì¼ì‹œì  ì•…ì¬", score:92, bb:"í•˜ë‹¨ì ‘ê·¼" },
  { ticker:"000660", name:"SKí•˜ì´ë‹‰ìŠ¤", roe:22.5, pbr:1.4, evEbit:6.1, debt:45, moat:"ì „í™˜ë¹„ìš©", discount:"âœ“ ì‚¬ì´í´ ì €ì ", score:88, bb:"Squeeze" },
  { ticker:"035420", name:"NAVER", roe:12.8, pbr:1.6, evEbit:14.2, debt:28, moat:"ë„¤íŠ¸ì›Œí¬", discount:"â–³ ì„±ì¥ ë‘”í™”", score:74, bb:"ì¤‘ë¦½" },
  { ticker:"051910", name:"LGí™”í•™", roe:8.3, pbr:0.7, evEbit:11.5, debt:65, moat:"ì›ê°€ìš°ìœ„", discount:"âœ— êµ¬ì¡°ì ", score:45, bb:"í•˜ë‹¨ì´íƒˆ" },
  { ticker:"006400", name:"ì‚¼ì„±SDI", roe:14.1, pbr:0.9, evEbit:7.8, debt:38, moat:"ì „í™˜ë¹„ìš©", discount:"âœ“ ì„¹í„° ì„¼í‹°ë¨¼íŠ¸", score:85, bb:"í•˜ë‹¨ì ‘ê·¼" },
];

function scoreBar(s) {
  const c = s>=80?"var(--green)":s>=60?"var(--orange)":"var(--red)";
  return `<div class="score-wrap"><div class="score-bar"><div class="score-fill" style="width:${s}%;background:${c};"></div></div><span class="score-num" style="color:${c};">${s}</span></div>`;
}

function renderKR() {
  document.getElementById("krTable").innerHTML = KR_DATA.map(s => `
    <tr>
      <td><div style="font-weight:700;">${s.name}</div><div style="font-size:10px;color:var(--muted);">${s.ticker}</div></td>
      <td style="color:${s.roe>=15?'var(--green)':'var(--dim)'};font-weight:600;">${s.roe}%</td>
      <td style="color:${s.pbr<=1.2?'var(--green)':'var(--text)'};">${s.pbr}x</td>
      <td>${s.evEbit}x</td>
      <td style="color:${s.debt>60?'var(--red)':'var(--text)'};">${s.debt}%</td>
      <td><span class="badge" style="color:var(--accent);background:var(--accent-dim);">${s.moat}</span></td>
      <td style="font-size:12px;color:${s.discount.startsWith('âœ“')?'var(--green)':s.discount.startsWith('âœ—')?'var(--red)':'var(--orange)'};">${s.discount}</td>
      <td><span class="badge ${s.bb==='í•˜ë‹¨ì ‘ê·¼'?'badge-high':s.bb==='Squeeze'?'':s.bb==='í•˜ë‹¨ì´íƒˆ'?'badge-high':''}" style="color:${s.bb==='í•˜ë‹¨ì ‘ê·¼'?'var(--green)':s.bb==='Squeeze'?'var(--orange)':s.bb==='í•˜ë‹¨ì´íƒˆ'?'var(--red)':'var(--muted)'};background:${s.bb==='í•˜ë‹¨ì ‘ê·¼'?'var(--green-dim)':s.bb==='Squeeze'?'var(--orange-dim)':s.bb==='í•˜ë‹¨ì´íƒˆ'?'var(--red-dim)':'var(--surface2)'};">${s.bb}</span></td>
      <td style="width:120px;">${scoreBar(s.score)}</td>
    </tr>`).join("");
}

// â”€â”€ ë¯¸ì¥ â”€â”€
const US_DATA = [
  { ticker:"AAPL", name:"Apple", roic:58.2, peg:2.1, moat:"ë¸Œëœë“œ+ìƒíƒœê³„", score:90, phase:"ë³´ìœ  ìœ ì§€" },
  { ticker:"MSFT", name:"Microsoft", roic:42.3, peg:1.8, moat:"ì „í™˜ë¹„ìš©+ë„¤íŠ¸ì›Œí¬", score:94, phase:"ë³´ìœ  ìœ ì§€" },
  { ticker:"COST", name:"Costco", roic:28.1, peg:2.8, moat:"ì›ê°€ìš°ìœ„", score:82, phase:"ê³ í‰ê°€ ì£¼ì˜" },
  { ticker:"GOOGL", name:"Alphabet", roic:32.5, peg:1.2, moat:"ë„¤íŠ¸ì›Œí¬+ë°ì´í„°", score:91, phase:"ì§„ì… ê°€ëŠ¥" },
  { ticker:"V", name:"Visa", roic:44.8, peg:1.5, moat:"ë„¤íŠ¸ì›Œí¬íš¨ê³¼", score:89, phase:"ë³´ìœ  ìœ ì§€" },
];

function renderUS() {
  document.getElementById("usTable").innerHTML = US_DATA.map(s => {
    const pc = s.phase.includes("ì§„ì…") ? "phase-enter" : s.phase.includes("ìœ ì§€") ? "phase-hold" : "phase-caution";
    return `<tr>
      <td><div style="font-weight:700;">${s.name}</div><div style="font-size:10px;color:var(--muted);">${s.ticker}</div></td>
      <td style="color:${s.roic>=30?'var(--green)':'var(--text)'};font-weight:600;">${s.roic}%</td>
      <td style="color:${s.peg<=1.5?'var(--green)':s.peg<=2?'var(--text)':'var(--orange)'};">${s.peg}x</td>
      <td><span class="badge" style="color:var(--accent);background:var(--accent-dim);">${s.moat}</span></td>
      <td style="width:120px;">${scoreBar(s.score)}</td>
      <td><span class="badge ${pc}">${s.phase}</span></td>
    </tr>`;
  }).join("");
}

// â”€â”€ ì±„ê¶Œ â”€â”€
const BONDS = [
  { name:"ë¯¸êµ­ 10Y êµ­ì±„", yield:"4.52%", change:"+0.03", up:true, signal:"ê¸ˆë¦¬ ìƒìŠ¹ â€” ì£¼ì‹ ë¹„ì¤‘ ì¶•ì†Œ ê³ ë ¤" },
  { name:"í•œêµ­ 3Y êµ­ì±„", yield:"3.28%", change:"-0.02", up:false, signal:"ì•ˆì •ì " },
  { name:"ë¯¸êµ­ 2Y-10Y ìŠ¤í”„ë ˆë“œ", yield:"0.15%", change:"+0.05", up:true, signal:"ì •ìƒí™” ì§„í–‰ ì¤‘" },
];
const COMMODITIES = [
  { name:"ê¸ˆ (Gold)", price:"$2,645", change:"+1.2%", up:true, signal:"ì•ˆì „ìì‚° ìˆ˜ìš” ìƒìŠ¹" },
  { name:"WTI ì›ìœ ", price:"$71.3", change:"-0.8%", up:false, signal:"ê³µê¸‰ ê³¼ì‰ ìš°ë ¤" },
  { name:"êµ¬ë¦¬", price:"$9,120", change:"+0.5%", up:true, signal:"ê²½ê¸° íšŒë³µ ì‹ í˜¸" },
];

function renderBonds() {
  document.getElementById("bondsContainer").innerHTML = `
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">
      ${BONDS.map(b => `
        <div class="card" style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;">
          <div><div style="font-size:13px;font-weight:600;">${b.name}</div><div style="font-size:11px;color:var(--muted);margin-top:2px;">${b.signal}</div></div>
          <div style="text-align:right;"><div style="font-size:18px;font-weight:700;">${b.yield}</div><div style="font-size:12px;color:${b.up?'var(--red)':'var(--green)'};">${b.change}</div></div>
        </div>`).join("")}
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
      ${COMMODITIES.map(c => `
        <div class="card">
          <div style="font-size:11px;color:var(--muted);margin-bottom:6px;">${c.name}</div>
          <div style="font-size:20px;font-weight:700;">${c.price}</div>
          <div style="font-size:12px;font-weight:600;color:${c.up?'var(--green)':'var(--red)'};">${c.change}</div>
          <div style="font-size:10px;color:var(--dim);margin-top:6px;">${c.signal}</div>
        </div>`).join("")}
    </div>`;
}

// â”€â”€ íˆ¬ì ì¼ì§€ â”€â”€
const JOURNAL = [
  { date:"2026-02-25", ticker:"005930", name:"ì‚¼ì„±ì „ì", action:"ë§¤ìˆ˜", reason:"ìì‚¬ì£¼ ë§¤ì… ê³µì‹œ + ROE 18% + PBR 1.1. ë³¼ë¦°ì € ë°´ë“œ í•˜ë‹¨ ì ‘ê·¼.", counter:"ë©”ëª¨ë¦¬ ì‚¬ì´í´ í”¼í¬ì•„ì›ƒ ê°€ëŠ¥ì„±. HBM ì „í™˜ì´ ë¦¬ìŠ¤í¬ ì™„í™”.", target:"82,000ì›" },
  { date:"2026-02-20", ticker:"MSFT", name:"Microsoft", action:"ë³´ìœ ìœ ì§€", reason:"ROIC 42%, AI/í´ë¼ìš°ë“œ ì„±ì¥ ì§€ì†. PEG 1.8 í•©ë¦¬ì .", counter:"ê·œì œ ë¦¬ìŠ¤í¬, OpenAI ì˜ì¡´ë„. Azure ì„±ì¥ìœ¼ë¡œ ë°©ì–´.", target:"$480" },
];

function renderJournal() {
  document.getElementById("journalContainer").innerHTML = JOURNAL.map(j => `
    <div class="card" style="margin-bottom:14px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
        <span class="badge" style="color:${j.action==='ë§¤ìˆ˜'?'var(--green)':'var(--blue)'};background:${j.action==='ë§¤ìˆ˜'?'var(--green-dim)':'var(--blue-dim)'};">${j.action}</span>
        <span style="font-size:14px;font-weight:700;">${j.name}</span>
        <span style="font-size:11px;color:var(--muted);">${j.ticker}</span>
        <span style="font-size:11px;color:var(--muted);margin-left:auto;">${j.date}</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div style="padding:12px;background:var(--green-dim);border-radius:8px;border-left:3px solid var(--green);">
          <div style="font-size:10px;font-weight:600;color:var(--green);margin-bottom:6px;">íˆ¬ì ë…¼ë¦¬</div>
          <div style="font-size:12px;line-height:1.6;">${j.reason}</div>
        </div>
        <div style="padding:12px;background:var(--red-dim);border-radius:8px;border-left:3px solid var(--red);">
          <div style="font-size:10px;font-weight:600;color:var(--red);margin-bottom:6px;">ë°˜ë¡  (ë‚´ê°€ ì™œ í‹€ë¦´ ìˆ˜ ìˆëŠ”ê°€)</div>
          <div style="font-size:12px;line-height:1.6;">${j.counter}</div>
        </div>
      </div>
      <div style="margin-top:10px;font-size:11px;"><span style="color:var(--muted);">ëª©í‘œê°€: </span><span style="color:var(--accent);font-weight:600;">${j.target}</span></div>
    </div>`).join("");
}

// â”€â”€ AI ì±„íŒ… â”€â”€
async function sendChat() {
  if (chatLoading) return;
  const input = document.getElementById("chatInput");
  const msg = input.value.trim();
  if (!msg) return;
  input.value = "";
  addMsg(msg, "user");
  chatLoading = true;

  let dartCtx = "";
  try {
    const r = await fetch(`${BACKEND}/dart/recent?days=7`);
    const json = await r.json();
    dartCtx = (json.data||[]).slice(0,5).map(d => `${d.company}: ${d.title} (${d.date})`).join("\n");
  } catch {}

  const systemPrompt = `ë‹¹ì‹ ì€ Andrewì˜ íˆ¬ì ë¶„ì„ AIì…ë‹ˆë‹¤. Draft 3.0 íˆ¬ì ì² í•™(ì›ŒëŸ° ë²„í• ê°€ì¹˜íˆ¬ì + í•˜ì›Œë“œ ë§‰ìŠ¤ ì‚¬ì´í´ + ì¹´ë„ˆë¨¼ í–‰ë™ê²½ì œí•™)ì„ ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.\n\nì˜¤ëŠ˜ì˜ ì‹¤ì œ DART ê³µì‹œ:\n${dartCtx||"ì—†ìŒ"}\n\në¶„ì„ ì‹œ ë°˜ë“œì‹œ: 1)íˆ¬ì ë…¼ë¦¬ 2)ë°˜ë¡  3)ê²°ë¡  í¬í•¨. í•œêµ­ì–´ë¡œ ê°„ê²°í•˜ê²Œ.`;

  try {
    const r = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ model: "claude-sonnet-4-20250514", max_tokens: 1000, system: systemPrompt, messages: [{ role: "user", content: msg }] })
    });
    const data = await r.json();
    addMsg(data.content?.[0]?.text || "ì‘ë‹µ ì˜¤ë¥˜", "ai");
  } catch {
    addMsg("AI ì‘ë‹µ ì˜¤ë¥˜ â€” ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", "ai");
  }
  chatLoading = false;
}

function addMsg(text, role) {
  const div = document.createElement("div");
  div.className = `msg msg-${role}`;
  div.textContent = text;
  const container = document.getElementById("chat-messages");
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

// â”€â”€ ì´ˆê¸°í™” â”€â”€
fetchDart();
</script>
</body>
</html>