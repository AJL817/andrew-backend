<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#00ff88">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="ANDREW">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Andrew Investment System</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans+KR:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
:root {
  --bg: #0a0d0f;
  --bg2: #0f1418;
  --bg3: #161c22;
  --bg4: #1d252e;
  --border: #1e2a35;
  --text: #c9d1d9;
  --text2: #8b949e;
  --text3: #484f58;
  --accent: #58a6ff;
  --green: #3fb950;
  --red: #f85149;
  --yellow: #d29922;
  --orange: #e3b341;
  --gold: #ffd700;
  --morning: #ff9500;
  --font-mono: 'IBM Plex Mono', monospace;
  --font-sans: 'IBM Plex Sans KR', sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: var(--font-sans); font-size: 13px; min-height: 100vh; }
::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-track { background: var(--bg2); } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* â”€â”€ HEADER â”€â”€ */
#header {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 46px;
  position: sticky; top: 0; z-index: 100;
}
#header .logo { font-family: var(--font-mono); font-size: 13px; font-weight: 600; letter-spacing: 2px; color: var(--accent); }
#header .logo span { color: var(--text3); font-weight: 300; }
#clock { font-family: var(--font-mono); font-size: 12px; color: var(--text2); }
#status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--green); display: inline-block; margin-right: 6px; box-shadow: 0 0 6px var(--green); animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
#status-dot.offline { background: var(--red); box-shadow: 0 0 6px var(--red); }

/* â”€â”€ TICKER BAR â”€â”€ */
#ticker-bar {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
  height: 32px;
  display: flex;
  align-items: center;
  gap: 24px;
  overflow-x: auto;
  white-space: nowrap;
}
.ticker-item { display: flex; align-items: center; gap: 6px; font-family: var(--font-mono); font-size: 11px; }
.ticker-name { color: var(--text2); }
.ticker-price { color: var(--text); font-weight: 500; }
.ticker-chg.up { color: var(--green); } .ticker-chg.dn { color: var(--red); } .ticker-chg.flat { color: var(--text2); }
.ticker-sep { color: var(--border); }

/* â”€â”€ TABS â”€â”€ */
#tabs {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 0 20px;
  display: flex;
  gap: 2px;
  overflow-x: auto;
}
.tab {
  padding: 10px 16px;
  font-size: 12px;
  font-weight: 500;
  color: var(--text2);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all .15s;
  white-space: nowrap;
  display: flex; align-items: center; gap: 6px;
}
.tab:hover { color: var(--text); }
.tab.active { color: var(--text); border-bottom-color: var(--accent); }
.tab.morning-tab.active { border-bottom-color: var(--morning); color: var(--morning); }
.tab.closing-tab.active { border-bottom-color: var(--green); color: var(--green); }
.tab.weekend-tab.active { border-bottom-color: #bc8cff; color: #bc8cff; }
.tab .badge { background: var(--accent); color: #000; font-size: 9px; padding: 1px 5px; border-radius: 8px; font-weight: 600; }
.tab.morning-tab .badge { background: var(--morning); }
.tab.closing-tab .badge { background: var(--green); }
.tab.weekend-tab .badge { background: #bc8cff; }

/* â”€â”€ MAIN â”€â”€ */
#main { padding: 20px; max-width: 1400px; margin: 0 auto; }
.section { display: none; }
.section.active { display: block; }

/* â”€â”€ CARDS â”€â”€ */
.card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 16px;
  transition: border-color .15s;
}
.card:hover { border-color: var(--bg4); }
.card-title { font-size: 11px; font-weight: 500; color: var(--text2); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
.card-title::before { content: ''; width: 3px; height: 12px; background: var(--accent); border-radius: 2px; display: inline-block; }
.morning-card .card-title::before { background: var(--morning); }
.closing-card .card-title::before { background: var(--green); }
.weekend-card .card-title::before { background: #bc8cff; }

/* â”€â”€ GRID â”€â”€ */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
.grid-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; }
@media(max-width:900px){ .grid-4{grid-template-columns:repeat(2,1fr);} .grid-3{grid-template-columns:1fr 1fr;} .grid-2{grid-template-columns:1fr;} }

/* â”€â”€ MARKET TILE â”€â”€ */
.mkt-tile {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 5px;
  padding: 12px 14px;
  cursor: pointer;
  transition: border-color .15s, background .15s;
}
.mkt-tile:hover { background: var(--bg4); border-color: var(--accent); }
.mkt-tile .mkt-label { font-size: 10px; color: var(--text2); letter-spacing: .5px; margin-bottom: 6px; }
.mkt-tile .mkt-val { font-family: var(--font-mono); font-size: 16px; font-weight: 600; color: var(--text); }
.mkt-tile .mkt-chg { font-family: var(--font-mono); font-size: 11px; margin-top: 3px; }
.mkt-tile .mkt-chg.up { color: var(--green); } .mkt-tile .mkt-chg.dn { color: var(--red); } .mkt-tile .mkt-chg.flat { color: var(--text2); }

/* â”€â”€ NEWS LIST â”€â”€ */
.news-item {
  padding: 11px 0;
  border-bottom: 1px solid var(--border);
  display: flex; gap: 10px;
  cursor: pointer;
  transition: background .1s;
}
.news-item:last-child { border-bottom: none; }
.news-item:hover { background: var(--bg3); margin: 0 -16px; padding: 11px 16px; border-radius: 4px; }
.news-source { font-size: 10px; font-weight: 600; color: var(--accent); min-width: 56px; padding-top: 2px; letter-spacing: .3px; }
.news-content .news-title { font-size: 13px; color: var(--text); line-height: 1.4; font-weight: 500; }
.news-content .news-desc { font-size: 11px; color: var(--text2); margin-top: 3px; line-height: 1.4; }
.news-content .news-date { font-size: 10px; color: var(--text3); margin-top: 3px; font-family: var(--font-mono); }

/* â”€â”€ DART ITEM â”€â”€ */
.dart-item {
  padding: 9px 0;
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;
}
.dart-item:last-child { border-bottom: none; }
.dart-company { font-size: 11px; font-weight: 600; color: var(--accent); min-width: 70px; }
.dart-title { font-size: 12px; color: var(--text); line-height: 1.4; flex: 1; }
.dart-title a { color: var(--text); text-decoration: none; } .dart-title a:hover { color: var(--accent); }
.dart-date { font-family: var(--font-mono); font-size: 10px; color: var(--text3); min-width: 80px; text-align: right; }
.dart-badge { font-size: 9px; padding: 2px 6px; border-radius: 3px; font-weight: 600; display: inline-block; }
.dart-badge.major { background: rgba(248,81,73,.15); color: var(--red); border: 1px solid rgba(248,81,73,.3); }
.dart-badge.normal { background: var(--bg3); color: var(--text3); border: 1px solid var(--border); }

/* â”€â”€ SECTION HEADER â”€â”€ */
.section-head {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px;
}
.section-head h2 { font-size: 14px; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 8px; }
.section-head .sub { font-size: 12px; color: var(--text2); font-weight: 400; }
.refresh-btn {
  background: var(--bg3); border: 1px solid var(--border); color: var(--text2);
  padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;
  font-family: var(--font-sans); transition: all .15s;
}
.refresh-btn:hover { border-color: var(--accent); color: var(--accent); }

/* â”€â”€ LOADING â”€â”€ */
.skeleton { background: linear-gradient(90deg, var(--bg3) 25%, var(--bg4) 50%, var(--bg3) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
@keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
.loading-bar { height: 14px; margin: 8px 0; } .loading-bar.w60{width:60%;} .loading-bar.w80{width:80%;} .loading-bar.w40{width:40%;}

/* â”€â”€ BRIEFING HERO â”€â”€ */
.briefing-hero {
  background: linear-gradient(135deg, var(--bg2) 0%, var(--bg3) 100%);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 24px;
  margin-bottom: 16px;
  position: relative; overflow: hidden;
}
.briefing-hero::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
}
.morning-hero::before { background: linear-gradient(90deg, var(--morning), transparent); }
.closing-hero::before { background: linear-gradient(90deg, var(--green), transparent); }
.weekend-hero::before { background: linear-gradient(90deg, #bc8cff, transparent); }
.hero-eyebrow { font-size: 10px; letter-spacing: 2px; font-weight: 600; margin-bottom: 6px; }
.morning-hero .hero-eyebrow { color: var(--morning); }
.closing-hero .hero-eyebrow { color: var(--green); }
.weekend-hero .hero-eyebrow { color: #bc8cff; }
.hero-title { font-size: 22px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
.hero-sub { font-size: 13px; color: var(--text2); }
.hero-time { position: absolute; top: 24px; right: 24px; font-family: var(--font-mono); font-size: 11px; color: var(--text3); text-align: right; }

/* â”€â”€ DIVIDER â”€â”€ */
.divider { border: none; border-top: 1px solid var(--border); margin: 16px 0; }
.gap { height: 12px; }

/* â”€â”€ PHILOSOPHY â”€â”€ */
.phil-section { margin-bottom: 20px; }
.phil-section h3 { font-size: 12px; font-weight: 600; color: var(--accent); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
.phil-row { display: flex; gap: 8px; align-items: flex-start; padding: 7px 0; border-bottom: 1px solid var(--border); }
.phil-row:last-child { border-bottom: none; }
.phil-num { font-family: var(--font-mono); font-size: 10px; color: var(--accent); min-width: 20px; padding-top: 2px; }
.phil-text { font-size: 12px; color: var(--text); line-height: 1.6; }
.phil-text strong { color: var(--orange); }
.no-list { list-style: none; }
.no-item { display: flex; gap: 8px; align-items: flex-start; padding: 6px 0; font-size: 12px; color: var(--text); }
.no-item::before { content: 'âœ•'; color: var(--red); font-family: var(--font-mono); font-size: 10px; padding-top: 2px; min-width: 16px; }
.bias-check { display: flex; flex-direction: column; gap: 8px; }
.bias-item { display: flex; gap: 10px; align-items: center; padding: 8px 12px; background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; transition: all .15s; }
.bias-item:hover { border-color: var(--accent); }
.bias-item input[type=checkbox] { width: 14px; height: 14px; accent-color: var(--accent); cursor: pointer; }
.bias-item label { font-size: 12px; color: var(--text); cursor: pointer; line-height: 1.4; flex: 1; }
.bias-item.checked { background: rgba(88,166,255,.06); border-color: rgba(88,166,255,.3); }
.bias-score { font-family: var(--font-mono); font-size: 24px; font-weight: 600; }
.bias-score.safe { color: var(--green); } .bias-score.caution { color: var(--yellow); } .bias-score.danger { color: var(--red); }
.quote-block { border-left: 2px solid var(--accent); padding: 10px 14px; margin: 8px 0; background: var(--bg3); border-radius: 0 4px 4px 0; }
.quote-block p { font-size: 12px; color: var(--text); line-height: 1.6; font-style: italic; }
.quote-block cite { font-size: 11px; color: var(--text2); margin-top: 4px; display: block; font-style: normal; }

/* â”€â”€ WATCHLIST â”€â”€ */
.stock-card {
  background: var(--bg2); border: 1px solid var(--border); border-radius: 6px;
  padding: 16px; cursor: pointer; transition: border-color .15s, background .15s;
  position: relative;
}
.stock-card:hover { border-color: var(--accent); background: var(--bg3); }
.stock-card.selected { border-color: var(--accent); background: var(--bg3); }
.stock-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.stock-name { font-size: 15px; font-weight: 600; color: var(--text); }
.stock-ticker { font-family: var(--font-mono); font-size: 11px; color: var(--text2); margin-top: 2px; }
.stock-market { font-size: 9px; padding: 2px 6px; border-radius: 3px; font-weight: 600; }
.stock-market.kr { background: rgba(63,185,80,.15); color: var(--green); border: 1px solid rgba(63,185,80,.3); }
.stock-market.us { background: rgba(88,166,255,.15); color: var(--accent); border: 1px solid rgba(88,166,255,.3); }
.stock-price-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.stock-price { font-family: var(--font-mono); font-size: 18px; font-weight: 600; color: var(--text); }
.stock-chg { font-family: var(--font-mono); font-size: 12px; }
.stock-chg.up { color: var(--green); } .stock-chg.dn { color: var(--red); }

.match-bar-wrap { margin-bottom: 8px; }
.match-bar-label { display: flex; justify-content: space-between; font-size: 10px; color: var(--text2); margin-bottom: 4px; }
.match-bar-track { height: 4px; background: var(--bg4); border-radius: 2px; overflow: hidden; }
.match-bar-fill { height: 100%; border-radius: 2px; transition: width .4s; }
.match-bar-fill.high { background: var(--green); }
.match-bar-fill.mid { background: var(--yellow); }
.match-bar-fill.low { background: var(--red); }

.stock-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
.stock-meta-item { font-size: 10px; background: var(--bg3); border: 1px solid var(--border); border-radius: 3px; padding: 3px 8px; color: var(--text2); }
.stock-meta-item strong { color: var(--text); }

/* ìƒì„¸ íŒ¨ë„ */
.detail-panel {
  background: var(--bg2); border: 1px solid var(--accent); border-radius: 6px;
  padding: 20px; margin-top: 12px;
}
.detail-tabs { display: flex; gap: 4px; margin-bottom: 16px; }
.detail-tab { padding: 6px 14px; font-size: 11px; border-radius: 4px; cursor: pointer; border: 1px solid var(--border); color: var(--text2); background: var(--bg3); transition: all .15s; }
.detail-tab.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 600; }
.detail-content { display: none; } .detail-content.active { display: block; }

.thesis-row { display: flex; gap: 8px; margin-bottom: 8px; }
.thesis-label { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 3px; min-width: 36px; text-align: center; }
.thesis-label.bull { background: rgba(63,185,80,.15); color: var(--green); }
.thesis-label.bear { background: rgba(248,81,73,.15); color: var(--red); }
.thesis-text { font-size: 12px; color: var(--text); line-height: 1.5; }

.prob-ring { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.prob-ring canvas { max-width: 120px; }
.prob-label { font-size: 11px; color: var(--text2); }
.prob-val { font-family: var(--font-mono); font-size: 20px; font-weight: 600; color: var(--green); }

.checklist-item { display: flex; gap: 8px; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
.checklist-item:last-child { border-bottom: none; }
.check-icon { font-size: 12px; min-width: 16px; }
.check-icon.pass { color: var(--green); } .check-icon.fail { color: var(--red); } .check-icon.warn { color: var(--yellow); }

.ai-analysis {
  background: linear-gradient(135deg, rgba(0,255,136,.06) 0%, rgba(88,166,255,.06) 100%);
  border: 1px solid rgba(0,255,136,.25); border-radius: 8px; margin-bottom: 16px; overflow: hidden;
}
.ai-analysis-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 16px; cursor: pointer; user-select: none;
}
.ai-analysis-header:hover { background: rgba(0,255,136,.08); }
.ai-analysis-title { font-size: 10px; font-weight: 700; color: var(--accent); letter-spacing: 1px; }
.ai-analysis-toggle { font-size: 14px; color: var(--accent); transition: transform .3s; font-weight: bold; }
.ai-analysis-toggle.open { transform: rotate(180deg); }
.ai-analysis-body { padding: 0 16px 16px; }
.ai-analysis-body.collapsed { display: none; }
.ai-analysis-text { font-size: 13px; color: var(--text); line-height: 1.9; }
.ai-label { font-size: 12px; font-weight: 700; color: var(--accent); margin: 14px 0 4px; display: block; letter-spacing: .5px; }
.ai-loading { display: flex; align-items: center; gap: 8px; color: var(--text3); font-size: 12px; }
.ai-dot { width:6px;height:6px;border-radius:50%;background:var(--accent);animation:aipulse 1s infinite; }
@keyframes aipulse { 0%,100%{opacity:.3} 50%{opacity:1} }


.peer-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 8px; }
.peer-table th { color: var(--text3); font-weight: 600; padding: 4px 8px; text-align: left; border-bottom: 1px solid var(--border); font-size: 10px; letter-spacing: .5px; }
.peer-table td { padding: 5px 8px; border-bottom: 1px solid var(--bg3); color: var(--text); }
.peer-table tr.peer-self { background: rgba(0,255,136,.07); }
.peer-table tr.peer-self td { color: var(--green); font-weight: 600; }
.peer-table tr:hover td { background: var(--bg3); }
.peer-rank-1 { color: var(--gold) !important; }

</style>
</head>
<body>

<!-- HEADER -->
<div id="header">
  <div class="logo">ANDREW<span>/INVEST</span> <span style="color:var(--text3);font-size:10px;margin-left:8px;">v2.0</span></div>
  <div style="display:flex;align-items:center;gap:16px;">
    <div style="font-size:11px;color:var(--text2);"><span id="status-dot"></span><span id="status-txt">ì—°ê²° í™•ì¸ ì¤‘</span></div>
    <div id="clock" style="font-family:var(--font-mono);font-size:12px;color:var(--text2);"></div>
  </div>
</div>

<!-- TICKER BAR -->
<div id="ticker-bar">
  <div class="ticker-item"><span class="ticker-name">S&P500</span><span class="ticker-price" id="tk-sp500">â€”</span><span class="ticker-chg" id="tk-sp500-chg">â€”</span></div>
  <div class="ticker-sep">â”‚</div>
  <div class="ticker-item"><span class="ticker-name">ë‚˜ìŠ¤ë‹¥</span><span class="ticker-price" id="tk-nasdaq">â€”</span><span class="ticker-chg" id="tk-nasdaq-chg">â€”</span></div>
  <div class="ticker-sep">â”‚</div>
  <div class="ticker-item"><span class="ticker-name">ì½”ìŠ¤í”¼</span><span class="ticker-price" id="tk-kospi">â€”</span><span class="ticker-chg" id="tk-kospi-chg">â€”</span></div>
  <div class="ticker-sep">â”‚</div>
  <div class="ticker-item"><span class="ticker-name">ì½”ìŠ¤ë‹¥</span><span class="ticker-price" id="tk-kosdaq">â€”</span><span class="ticker-chg" id="tk-kosdaq-chg">â€”</span></div>
  <div class="ticker-sep">â”‚</div>
  <div class="ticker-item"><span class="ticker-name">ë‹¬ëŸ¬/ì›</span><span class="ticker-price" id="tk-usdkrw">â€”</span><span class="ticker-chg" id="tk-usdkrw-chg">â€”</span></div>
  <div class="ticker-sep">â”‚</div>
  <div class="ticker-item"><span class="ticker-name">ê¸ˆ</span><span class="ticker-price" id="tk-gold">â€”</span><span class="ticker-chg" id="tk-gold-chg">â€”</span></div>
  <div class="ticker-sep">â”‚</div>
  <div class="ticker-item"><span class="ticker-name">WTI</span><span class="ticker-price" id="tk-wti">â€”</span><span class="ticker-chg" id="tk-wti-chg">â€”</span></div>
  <div class="ticker-sep">â”‚</div>
  <div class="ticker-item"><span class="ticker-name">ë¯¸10ë…„</span><span class="ticker-price" id="tk-us10y">â€”</span><span class="ticker-chg" id="tk-us10y-chg">â€”</span></div>
</div>

<!-- TABS -->
<div id="tabs">
  <div class="tab active" onclick="switchTab('dashboard', this)">ğŸ“Š ëŒ€ì‹œë³´ë“œ</div>
  <div class="tab morning-tab" id="tab-morning" onclick="switchTab('morning', this)">ğŸŒ… ëª¨ë‹ë¸Œë¦¬í•‘</div>
  <div class="tab closing-tab" id="tab-closing" onclick="switchTab('closing', this)">ğŸ êµ­ì¥ë§ˆê°</div>
  <div class="tab weekend-tab" id="tab-weekend" onclick="switchTab('weekend', this)">ğŸ“° ì£¼ë§ë‰´ìŠ¤</div>
  <div class="tab" id="tab-kr" onclick="switchTab('kr', this)">ğŸ‡°ğŸ‡· êµ­ì¥ë¶„ì„</div>
  <div class="tab" id="tab-us" onclick="switchTab('us', this)">ğŸ‡ºğŸ‡¸ ë¯¸ì¥ë¶„ì„</div>
  <div class="tab" onclick="switchTab('dart', this)">ğŸ“‹ DARTê³µì‹œ</div>
  <div class="tab" onclick="switchTab('philosophy', this)">ğŸ“– íˆ¬ìì² í•™</div>
</div>

<!-- MAIN -->
<div id="main">

  <!-- â•â• ëŒ€ì‹œë³´ë“œ â•â• -->
  <div id="sec-dashboard" class="section active">
    <div class="section-head">
      <h2>ğŸ“Š ë§ˆì¼“ ì˜¤ë²„ë·° <span class="sub" id="mkt-updated"></span></h2>
      <button class="refresh-btn" onclick="loadMarket()">â†» ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div class="ai-analysis">
      <div class="ai-analysis-header" onclick="toggleAI('dashboard-analysis')">
        <span class="ai-analysis-title">â¬¡ AI ì‹œí™© ë¶„ì„</span>
        <span class="ai-analysis-toggle" id="dashboard-analysis-toggle">â–¼</span>
      </div>
      <div class="ai-analysis-body" id="dashboard-analysis">
        <div class="ai-loading"><div class="ai-dot"></div> AIê°€ ì‹œí™©ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”...</div>
      </div>
    </div>
    <div style="margin-bottom:16px;">
      <div class="card-title" style="margin-bottom:10px;">ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ì£¼ìš” ì§€ìˆ˜</div>
      <div class="grid-4">
        <div class="mkt-tile"><div class="mkt-label">S&amp;P 500</div><div class="mkt-val" id="m-sp500">â€”</div><div class="mkt-chg" id="m-sp500-c">â€”</div></div>
        <div class="mkt-tile"><div class="mkt-label">ë‚˜ìŠ¤ë‹¥</div><div class="mkt-val" id="m-nasdaq">â€”</div><div class="mkt-chg" id="m-nasdaq-c">â€”</div></div>
        <div class="mkt-tile"><div class="mkt-label">ë‹¤ìš°ì¡´ìŠ¤</div><div class="mkt-val" id="m-dow">â€”</div><div class="mkt-chg" id="m-dow-c">â€”</div></div>
        <div class="mkt-tile"><div class="mkt-label">ë‹¬ëŸ¬ì¸ë±ìŠ¤ (KRW)</div><div class="mkt-val" id="m-usdkrw">â€”</div><div class="mkt-chg" id="m-usdkrw-c">â€”</div></div>
      </div>
    </div>
    <div style="margin-bottom:16px;">
      <div class="card-title" style="margin-bottom:10px;">ğŸ‡°ğŸ‡· í•œêµ­ ì‹œì¥</div>
      <div class="grid-4">
        <div class="mkt-tile"><div class="mkt-label">ì½”ìŠ¤í”¼</div><div class="mkt-val" id="m-kospi">â€”</div><div class="mkt-chg" id="m-kospi-c">â€”</div></div>
        <div class="mkt-tile"><div class="mkt-label">ì½”ìŠ¤ë‹¥</div><div class="mkt-val" id="m-kosdaq">â€”</div><div class="mkt-chg" id="m-kosdaq-c">â€”</div></div>
        <div class="mkt-tile"><div class="mkt-label">USD/KRW</div><div class="mkt-val" id="m-usdkrw2">â€”</div><div class="mkt-chg" id="m-usdkrw2-c">â€”</div></div>
        <div class="mkt-tile"><div class="mkt-label">ì—”/ë‹¬ëŸ¬ (JPY)</div><div class="mkt-val" id="m-usdjpy">â€”</div><div class="mkt-chg" id="m-usdjpy-c">â€”</div></div>
      </div>
    </div>
    <div class="grid-2" style="margin-bottom:16px;">
      <div>
        <div class="card-title" style="margin-bottom:10px;">ğŸ“ˆ ì±„ê¶Œ ê¸ˆë¦¬</div>
        <div class="grid-2">
          <div class="mkt-tile"><div class="mkt-label">ë¯¸êµ­ 10ë…„ë¬¼</div><div class="mkt-val" id="m-us10y">â€”</div><div class="mkt-chg" id="m-us10y-c">â€”</div></div>
          <div class="mkt-tile"><div class="mkt-label">ë¯¸êµ­ 2ë…„ë¬¼</div><div class="mkt-val" id="m-us2y">â€”</div><div class="mkt-chg" id="m-us2y-c">â€”</div></div>
        </div>
      </div>
      <div>
        <div class="card-title" style="margin-bottom:10px;">ğŸ›¢ï¸ ì›ìì¬</div>
        <div class="grid-3">
          <div class="mkt-tile"><div class="mkt-label">ê¸ˆ (Gold)</div><div class="mkt-val" id="m-gold">â€”</div><div class="mkt-chg" id="m-gold-c">â€”</div></div>
          <div class="mkt-tile"><div class="mkt-label">WTI ì›ìœ </div><div class="mkt-val" id="m-wti">â€”</div><div class="mkt-chg" id="m-wti-c">â€”</div></div>
          <div class="mkt-tile"><div class="mkt-label">êµ¬ë¦¬ (Copper)</div><div class="mkt-val" id="m-copper">â€”</div><div class="mkt-chg" id="m-copper-c">â€”</div></div>
<div class="mkt-tile"><div class="mkt-label">ì€ (Silver)</div><div class="mkt-val" id="m-silver">â€”</div><div class="mkt-chg" id="m-silver-c">â€”</div></div>
<div class="mkt-tile"><div class="mkt-label">VIX ê³µí¬ì§€ìˆ˜</div><div class="mkt-val" id="m-vix">â€”</div><div class="mkt-chg" id="m-vix-c">â€”</div></div>
<div class="mkt-tile"><div class="mkt-label">VKOSPI</div><div class="mkt-val" id="m-vkospi">â€”</div><div class="mkt-chg" id="m-vkospi-c">â€”</div></div>
        </div>
      </div>
    </div>
    <hr class="divider">
    <div class="section-head">
      <h2>ğŸ“‹ ì˜¤ëŠ˜ì˜ ì£¼ìš” ê³µì‹œ</h2>
      <button class="refresh-btn" onclick="loadDart()">â†» ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div class="card" id="dash-dart-list"><div class="loading-bar skeleton w80"></div><div class="loading-bar skeleton w60"></div><div class="loading-bar skeleton w70"></div></div>
  </div>

  <!-- â•â• ëª¨ë‹ ë¸Œë¦¬í•‘ â•â• -->
  <div id="sec-morning" class="section">
    <div class="briefing-hero morning-hero">
      <div class="hero-eyebrow">MORNING BRIEFING</div>
      <div class="hero-title">ğŸŒ… êµ¿ëª¨ë‹, Andrew</div>
      <div class="hero-sub" id="morning-sub">ì˜¤ëŠ˜ ì‹œì¥ì„ ì‹œì‘í•˜ê¸° ì „, ë†“ì¹˜ë©´ ì•ˆ ë  í•µì‹¬ë§Œ ì •ë¦¬í–ˆì–´ìš”.</div>
      <div class="hero-time" id="morning-time"></div>
    </div>
    <div class="ai-analysis" id="morning-analysis-wrap">
    <div class="ai-analysis-header" onclick="toggleAI('morning-analysis')">
      <span class="ai-analysis-title">â¬¡ AI ì‹œí™© ë¶„ì„</span>
      <span class="ai-analysis-toggle" id="morning-analysis-toggle">â–¼</span>
    </div>
    <div class="ai-analysis-body" id="morning-analysis">
      <div class="ai-loading"><div class="ai-dot"></div> AIê°€ ì‹œí™©ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”...</div>
    </div>
  </div>
    <div class="grid-2" style="margin-bottom:16px;">
      <div class="card morning-card">
        <div class="card-title">ğŸ‡ºğŸ‡¸ ì „ë‚  ë¯¸êµ­ ì‹œì¥ ë§ˆê°</div>
        <div class="grid-2" id="morning-us">
          <div class="mkt-tile"><div class="mkt-label">S&P 500</div><div class="mkt-val" id="mm-sp500">â€”</div><div class="mkt-chg" id="mm-sp500-c">â€”</div></div>
          <div class="mkt-tile"><div class="mkt-label">ë‚˜ìŠ¤ë‹¥</div><div class="mkt-val" id="mm-nasdaq">â€”</div><div class="mkt-chg" id="mm-nasdaq-c">â€”</div></div>
          <div class="mkt-tile"><div class="mkt-label">ë‹¤ìš°</div><div class="mkt-val" id="mm-dow">â€”</div><div class="mkt-chg" id="mm-dow-c">â€”</div></div>
          <div class="mkt-tile"><div class="mkt-label">USD/KRW</div><div class="mkt-val" id="mm-usdkrw">â€”</div><div class="mkt-chg" id="mm-usdkrw-c">â€”</div></div>
        </div>
      </div>
      <div class="card morning-card">
        <div class="card-title">ğŸ“ˆ ì±„ê¶Œ &amp; ì›ìì¬</div>
        <div class="grid-2">
          <div class="mkt-tile"><div class="mkt-label">ë¯¸10ë…„ë¬¼</div><div class="mkt-val" id="mm-us10y">â€”</div><div class="mkt-chg" id="mm-us10y-c">â€”</div></div>
          <div class="mkt-tile"><div class="mkt-label">ë¯¸2ë…„ë¬¼</div><div class="mkt-val" id="mm-us2y">â€”</div><div class="mkt-chg" id="mm-us2y-c">â€”</div></div>
          <div class="mkt-tile"><div class="mkt-label">ê¸ˆ</div><div class="mkt-val" id="mm-gold">â€”</div><div class="mkt-chg" id="mm-gold-c">â€”</div></div>
          <div class="mkt-tile"><div class="mkt-label">ì€</div><div class="mkt-val" id="mm-silver">â€”</div><div class="mkt-chg" id="mm-silver-c">â€”</div></div>
          <div class="mkt-tile"><div class="mkt-label">WTI</div><div class="mkt-val" id="mm-wti">â€”</div><div class="mkt-chg" id="mm-wti-c">â€”</div></div>
          <div class="mkt-tile"><div class="mkt-label">VIX</div><div class="mkt-val" id="mm-vix">â€”</div><div class="mkt-chg" id="mm-vix-c">â€”</div></div>
        </div>
      </div>
    </div>
    <div class="grid-2">
      <div class="card morning-card">
        <div class="card-title">ğŸ“° ì˜¤ì „ ì£¼ìš” ë‰´ìŠ¤</div>
        <div id="morning-news"><div class="loading-bar skeleton w80"></div><div class="loading-bar skeleton w60"></div></div>
      </div>
      <div class="card morning-card">
        <div class="card-title">ğŸ“‹ ì˜¤ëŠ˜ ê³µì‹œ ì˜ˆì • / ì‹ ê·œ</div>
        <div id="morning-dart"><div class="loading-bar skeleton w70"></div><div class="loading-bar skeleton w50"></div></div>
      </div>
    </div>
  </div>

  <!-- â•â• êµ­ì¥ ë§ˆê° â•â• -->
  <div id="sec-closing" class="section">
    <div class="briefing-hero closing-hero">
      <div class="hero-eyebrow">MARKET CLOSE</div>
      <div class="hero-title">ğŸ ì˜¤ëŠ˜ êµ­ì¥ ë§ˆê° ì •ë¦¬</div>
      <div class="hero-sub">ì½”ìŠ¤í”¼Â·ì½”ìŠ¤ë‹¥ ë§ˆê° ìš”ì•½ + íŠ¹ì´ ì´ìŠˆ</div>
      <div class="hero-time" id="closing-time"></div>
    </div>
    <div class="ai-analysis" id="closing-analysis-wrap">
    <div class="ai-analysis-header" onclick="toggleAI('closing-analysis')">
      <span class="ai-analysis-title">â¬¡ AI ì‹œí™© ë¶„ì„</span>
      <span class="ai-analysis-toggle" id="closing-analysis-toggle">â–¼</span>
    </div>
    <div class="ai-analysis-body" id="closing-analysis">
      <div class="ai-loading"><div class="ai-dot"></div> AIê°€ ì‹œí™©ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”...</div>
    </div>
  </div>
    <div class="grid-2" style="margin-bottom:16px;">
      <div class="card closing-card">
        <div class="card-title">ğŸ‡°ğŸ‡· ì˜¤ëŠ˜ êµ­ì¥ ë§ˆê°</div>
        <div class="grid-2">
          <div class="mkt-tile"><div class="mkt-label">ì½”ìŠ¤í”¼</div><div class="mkt-val" id="cl-kospi">â€”</div><div class="mkt-chg" id="cl-kospi-c">â€”</div></div>
          <div class="mkt-tile"><div class="mkt-label">ì½”ìŠ¤ë‹¥</div><div class="mkt-val" id="cl-kosdaq">â€”</div><div class="mkt-chg" id="cl-kosdaq-c">â€”</div></div>
          <div class="mkt-tile"><div class="mkt-label">USD/KRW</div><div class="mkt-val" id="cl-usdkrw">â€”</div><div class="mkt-chg" id="cl-usdkrw-c">â€”</div></div>
          <div class="mkt-tile"><div class="mkt-label">JPY/USD</div><div class="mkt-val" id="cl-usdjpy">â€”</div><div class="mkt-chg" id="cl-usdjpy-c">â€”</div></div>
        </div>
      </div>
      <div class="card closing-card">
        <div class="card-title">ğŸ“‹ ì˜¤ëŠ˜ ì£¼ìš” ê³µì‹œ</div>
        <div id="closing-dart"><div class="loading-bar skeleton w80"></div><div class="loading-bar skeleton w60"></div></div>
      </div>
    </div>
    <div class="card closing-card">
      <div class="card-title">ğŸ“° ë§ˆê° ë‰´ìŠ¤</div>
      <div id="closing-news"><div class="loading-bar skeleton w80"></div><div class="loading-bar skeleton w60"></div></div>
    </div>
  </div>

  <!-- â•â• ì£¼ë§ ë‰´ìŠ¤ â•â• -->
  <div id="sec-weekend" class="section">
    <div class="briefing-hero weekend-hero">
      <div class="hero-eyebrow">WEEKEND DIGEST</div>
      <div class="hero-title">ğŸ“° ì£¼ë§ ì‚¬ì„¤ &amp; ì£¼ìš”ë‰´ìŠ¤</div>
      <div class="hero-sub">ì¥ì´ ì‰¬ëŠ” ì£¼ë§, ì´ë²ˆ ì£¼ í•µì‹¬ ì´ìŠˆì™€ ë‹¤ìŒ ì£¼ ì „ë§</div>
      <div class="hero-time" id="weekend-time"></div>
    </div>
    <div class="ai-analysis" id="weekend-analysis-wrap">
    <div class="ai-analysis-header" onclick="toggleAI('weekend-analysis')">
      <span class="ai-analysis-title">â¬¡ AI ì‹œí™© ë¶„ì„</span>
      <span class="ai-analysis-toggle" id="weekend-analysis-toggle">â–¼</span>
    </div>
    <div class="ai-analysis-body" id="weekend-analysis">
      <div class="ai-loading"><div class="ai-dot"></div> AIê°€ ì‹œí™©ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”...</div>
    </div>
  </div>
    <div class="grid-2">
      <div class="card weekend-card">
        <div class="card-title">ğŸ“° ì£¼ìš” ë‰´ìŠ¤ &amp; ì‚¬ì„¤</div>
        <div id="weekend-news"><div class="loading-bar skeleton w80"></div><div class="loading-bar skeleton w60"></div></div>
      </div>
      <div class="card weekend-card">
        <div class="card-title">ğŸ“‹ ì´ë²ˆ ì£¼ ê³µì‹œ ìš”ì•½</div>
        <div id="weekend-dart"><div class="loading-bar skeleton w70"></div><div class="loading-bar skeleton w50"></div></div>
      </div>
    </div>
  </div>

  <!-- â•â• êµ­ì¥ ë¶„ì„ â•â• -->
  <div id="sec-kr" class="section">
    <div class="section-head">
      <h2>ğŸ‡°ğŸ‡· êµ­ì¥ ìŠ¤í¬ë¦¬ë„ˆ â€” Draft 3.0 ì² í•™ ì‹¤ì‹œê°„ ì±„ì </h2>
      <div style="display:flex;gap:8px;align-items:center;">
        <span id="kr-status" style="font-size:11px;color:var(--text3);"></span>
        <button class="refresh-btn" onclick="loadScreener('kr', true)">â†» ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
    <div style="margin-bottom:12px;padding:10px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:5px;font-size:12px;color:var(--text2);">
      ğŸ“ ì±„ì  ê¸°ì¤€: <strong style="color:var(--text);">PBR Ã— ROE Ã— ë°°ë‹¹ìˆ˜ìµë¥  Ã— PER</strong> â€” êµ­ì¥ ì² í•™ 4ê°œ ì§€í‘œ ì‹¤ì‹œê°„ ìŠ¤ì½”ì–´ë§
    </div>
    <div class="grid-3" id="stock-grid-kr" style="margin-bottom:16px;"></div>
    <div id="detail-panel-kr" style="display:none;"></div>
  </div>

  <!-- â•â• ë¯¸ì¥ ë¶„ì„ â•â• -->
  <div id="sec-us" class="section">
    <div class="section-head">
      <h2>ğŸ‡ºğŸ‡¸ ë¯¸ì¥ ìŠ¤í¬ë¦¬ë„ˆ â€” Draft 3.0 ì² í•™ ì‹¤ì‹œê°„ ì±„ì </h2>
      <div style="display:flex;gap:8px;align-items:center;">
        <span id="us-status" style="font-size:11px;color:var(--text3);"></span>
        <button class="refresh-btn" onclick="loadScreener('us', true)">â†» ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
    <div style="margin-bottom:12px;padding:10px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:5px;font-size:12px;color:var(--text2);">
      ğŸ“ ì±„ì  ê¸°ì¤€: <strong style="color:var(--text);">PEG Ã— ROE Ã— FCF Ã— Fwd PER</strong> â€” ë¯¸ì¥ ì² í•™ 4ê°œ ì§€í‘œ ì‹¤ì‹œê°„ ìŠ¤ì½”ì–´ë§
    </div>
    <div class="grid-3" id="stock-grid-us" style="margin-bottom:16px;"></div>
    <div id="detail-panel-us" style="display:none;"></div>
  </div>

  <!-- â•â• DART ê³µì‹œ â•â• -->
  <div id="sec-dart" class="section">
    <div class="section-head">
      <h2>ğŸ“‹ DART ì „ìê³µì‹œ ì‹¤ì‹œê°„</h2>
      <div style="display:flex;gap:8px;align-items:center;">
        <select id="dart-days" onchange="loadDartFull()" style="background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:5px 10px;border-radius:4px;font-size:11px;cursor:pointer;">
          <option value="3">ìµœê·¼ 3ì¼</option>
          <option value="7" selected>ìµœê·¼ 7ì¼</option>
          <option value="14">ìµœê·¼ 14ì¼</option>
          <option value="30">ìµœê·¼ 30ì¼</option>
        </select>
        <button class="refresh-btn" onclick="loadDartFull()">â†» ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
    <div class="card" id="dart-full-list"><div class="loading-bar skeleton w80"></div><div class="loading-bar skeleton w60"></div></div>
  </div>

  <!-- â•â• íˆ¬ì ì² í•™ â•â• -->
  <div id="sec-philosophy" class="section">
    <div class="section-head"><h2>ğŸ“– Draft 3.0 â€” Andrew Investment Philosophy</h2></div>
    <div class="grid-2">
      <!-- ì™¼ìª½ -->
      <div>
        <div class="card" style="margin-bottom:12px;">
          <div class="card-title">ğŸ¯ í•µì‹¬ ì² í•™ 3ì›ì¹™</div>
          <div class="phil-section">
            <div class="quote-block">
              <p>ë‚´ê°€ ì´í•´í•˜ì§€ ëª»í•˜ëŠ” ì‚¬ì—…ì—ëŠ” íˆ¬ìí•˜ì§€ ì•ŠëŠ”ë‹¤. í™•ì‹ ì´ ì—†ìœ¼ë©´ ë§¤ìˆ˜í•˜ì§€ ì•ŠëŠ”ë‹¤. ì‹¸ê²Œ ì‚¬ëŠ” ê²ƒë³´ë‹¤ ì¢‹ì€ ì‚¬ì—…ì„ ì‚¬ëŠ” ê²ƒì´ ë‚«ë‹¤.</p>
              <cite>â€” Warren Buffett ì›ì¹™ ê¸°ë°˜</cite>
            </div>
            <div class="quote-block" style="border-color:var(--orange);">
              <p>ë¦¬ìŠ¤í¬ëŠ” ë¬´ì§€ì—ì„œ ì˜¨ë‹¤. ê°€ê²©ì´ ë‚´ ìƒê°ë³´ë‹¤ ë¹ ë¥´ê²Œ ë‚´ë¦´ ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ í•­ìƒ ì¸ì •í•˜ê³ , í•˜ë°©ì„ ë¨¼ì € ê³„ì‚°í•œë‹¤.</p>
              <cite>â€” Howard Marks ê¸°ë°˜</cite>
            </div>
            <div class="quote-block" style="border-color:var(--green);">
              <p>ë‚´ íŒë‹¨ì´ í‹€ë¦´ ìˆ˜ ìˆë‹¤. í™•ì¦í¸í–¥ì„ ê²½ê³„í•˜ê³ , ë§¤ìˆ˜ ì „ ë°˜ë“œì‹œ ë°˜ë¡ ì„ ë¨¼ì € ì°¾ì•„ë³¸ë‹¤.</p>
              <cite>â€” Kahneman ê¸°ë°˜</cite>
            </div>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px;">
          <div class="card-title">ğŸ‡°ğŸ‡· êµ­ì¥ íˆ¬ì ê¸°ì¤€</div>
          <div class="phil-section">
            <div class="phil-row"><div class="phil-num">1</div><div class="phil-text">PBR 1ë°° ì´í•˜ ë˜ëŠ” <strong>ëª…í™•í•œ ì¬í‰ê°€ íŠ¸ë¦¬ê±°</strong> ì¡´ì¬</div></div>
            <div class="phil-row"><div class="phil-num">2</div><div class="phil-text">ROE 10% ì´ìƒ or ê°œì„  ì¶”ì„¸ + <strong>ë°°ë‹¹ ìˆ˜ìµë¥  3% ì´ìƒ</strong></div></div>
            <div class="phil-row"><div class="phil-num">3</div><div class="phil-text">ì§€ë°°êµ¬ì¡° ë¦¬ìŠ¤í¬ ê²€í†  â€” <strong>ì˜¤ë„ˆ ë¦¬ìŠ¤í¬, ê´€ê³„ì‚¬ ì´ìŠˆ</strong> í™•ì¸</div></div>
            <div class="phil-row"><div class="phil-num">4</div><div class="phil-text">ì™¸êµ­ì¸Â·ê¸°ê´€ ìˆ˜ê¸‰ íë¦„ + <strong>ì½”ë¦¬ì•„ ë””ìŠ¤ì¹´ìš´íŠ¸ í•´ì†Œ ê°€ëŠ¥ì„±</strong></div></div>
            <div class="phil-row"><div class="phil-num">5</div><div class="phil-text">ëª©í‘œì£¼ê°€ ëŒ€ë¹„ <strong>30% ì´ìƒ ì•ˆì „ë§ˆì§„</strong> í™•ë³´ í›„ ì§„ì…</div></div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">ğŸ‡ºğŸ‡¸ ë¯¸ì¥ íˆ¬ì ê¸°ì¤€</div>
          <div class="phil-section">
            <div class="phil-row"><div class="phil-num">1</div><div class="phil-text"><strong>ê²½ì œì  í•´ì(Moat)</strong> â€” ë¸Œëœë“œ, ë„¤íŠ¸ì›Œí¬ íš¨ê³¼, ì „í™˜ë¹„ìš©, ì›ê°€ìš°ìœ„</div></div>
            <div class="phil-row"><div class="phil-num">2</div><div class="phil-text">ì‰ì—¬í˜„ê¸ˆíë¦„(FCF) ì„±ì¥ + <strong>ROIC 15% ì´ìƒ</strong> ì§€ì†</div></div>
            <div class="phil-row"><div class="phil-num">3</div><div class="phil-text">DCF ê¸°ì¤€ ë‚´ì¬ê°€ì¹˜ ëŒ€ë¹„ <strong>20~30% í• ì¸</strong> ë§¤ìˆ˜</div></div>
            <div class="phil-row"><div class="phil-num">4</div><div class="phil-text">ê²½ì˜ì§„ ìë³¸ë°°ë¶„ ëŠ¥ë ¥ â€” <strong>ìì‚¬ì£¼ë§¤ì…, M&amp;A ì´ë ¥</strong> ê²€í† </div></div>
            <div class="phil-row"><div class="phil-num">5</div><div class="phil-text">S&amp;P500 í‰ê·  ì´í•˜ PEG ratio + <strong>ì„¹í„° 1ìœ„ ë˜ëŠ” ë…ì ì  í¬ì§€ì…˜</strong></div></div>
          </div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ -->
      <div>
        <div class="card" style="margin-bottom:12px;">
          <div class="card-title">ğŸš¦ ë§¤ìˆ˜ ì „ 8ë‹¨ê³„ ì²´í¬</div>
          <div class="phil-section">
            <div class="phil-row"><div class="phil-num">â‘ </div><div class="phil-text">ì´ ì‚¬ì—…ì„ <strong>í•œ ë¬¸ì¥ìœ¼ë¡œ</strong> ì„¤ëª…í•  ìˆ˜ ìˆëŠ”ê°€?</div></div>
            <div class="phil-row"><div class="phil-num">â‘¡</div><div class="phil-text"><strong>5ë…„ í›„</strong> ì´ íšŒì‚¬ê°€ ì§€ê¸ˆë³´ë‹¤ ë” ê°•í•´ì§ˆ ì´ìœ ê°€ ìˆëŠ”ê°€?</div></div>
            <div class="phil-row"><div class="phil-num">â‘¢</div><div class="phil-text">ìµœì•…ì˜ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ <strong>ì›ê¸ˆ ì†ì‹¤ ìµœëŒ€ì¹˜</strong>ëŠ” ì–¼ë§ˆì¸ê°€?</div></div>
            <div class="phil-row"><div class="phil-num">â‘£</div><div class="phil-text"><strong>ì£¼ê°€ í•˜ë½ ì‹œ</strong> ì¶”ê°€ ë§¤ìˆ˜í•  í™•ì‹ ì´ ìˆëŠ”ê°€?</div></div>
            <div class="phil-row"><div class="phil-num">â‘¤</div><div class="phil-text"><strong>ë°˜ë¡ (Bull vs Bear)</strong>ì„ 3ê°€ì§€ ì´ìƒ ë§í•  ìˆ˜ ìˆëŠ”ê°€?</div></div>
            <div class="phil-row"><div class="phil-num">â‘¥</div><div class="phil-text">ì§€ê¸ˆ ë§¤ìˆ˜í•˜ëŠ” ì´ìœ ê°€ <strong>ë‘ë ¤ì›€ì´ë‚˜ FOMO</strong>ëŠ” ì•„ë‹Œê°€?</div></div>
            <div class="phil-row"><div class="phil-num">â‘¦</div><div class="phil-text"><strong>ë§¤ë„ ê¸°ì¤€</strong>ì„ ì‚¬ì „ì— ì„¤ì •í–ˆëŠ”ê°€? (ëª©í‘œê°€/ì†ì ˆê°€)</div></div>
            <div class="phil-row"><div class="phil-num">â‘§</div><div class="phil-text">ì´ ì¢…ëª©ì´ í¬íŠ¸í´ë¦¬ì˜¤ <strong>ì „ì²´ ë¦¬ìŠ¤í¬</strong>ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì€?</div></div>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px;">
          <div class="card-title">ğŸš« ì ˆëŒ€ ê¸ˆì§€ ì›ì¹™</div>
          <ul class="no-list">
            <li class="no-item">ì´í•´ ëª» í•˜ëŠ” ì‚¬ì—… ëª¨ë¸ì— íˆ¬ì (ìœ íŠœë²„ ì¶”ì²œ í¬í•¨)</li>
            <li class="no-item">ë ˆë²„ë¦¬ì§€/ë¹šíˆ¬ â€” ì–´ë–¤ ìƒí™©ì—ì„œë„ ê¸ˆì§€</li>
            <li class="no-item">ìƒí•œê°€ ì¶”ê²© ë§¤ìˆ˜, ë‹¨íƒ€ ì¶©ë™ ë§¤ìˆ˜</li>
            <li class="no-item">ì†ì‹¤ í›„ í‰ê· ë‹¨ê°€ ë‚®ì¶”ê¸° ìœ„í•œ ë¬´ê³„íš ë¬¼íƒ€ê¸°</li>
            <li class="no-item">í•œ ì¢…ëª© í¬íŠ¸í´ë¦¬ì˜¤ 30% ì´ˆê³¼ ì§‘ì¤‘</li>
            <li class="no-item">ê³µì‹œÂ·ë‰´ìŠ¤ í™•ì¸ ì—†ì´ ì‹œê°€/ë™ì‹œí˜¸ê°€ ë§¤ìˆ˜</li>
            <li class="no-item">ê°ì •ì  ì†ì ˆ (ê³µí¬ë¡œ ì¸í•œ ë°”ë‹¥ ë§¤ë„)</li>
            <li class="no-item">ëª©í‘œê°€ ë¯¸ë„ë‹¬ ì‹œ ìš•ì‹¬ìœ¼ë¡œ ì¸í•œ ë§¤ë„ ì§€ì—°</li>
          </ul>
        </div>

        <div class="card">
          <div class="card-title" id="bias-title">ğŸ§  ë§¤ìˆ˜ ì „ ë°”ì´ì–´ìŠ¤ ì²´í¬ (<span id="bias-score-txt" class="bias-score safe">0</span>/8)</div>
          <div class="bias-check" id="bias-list">
            <div class="bias-item" onclick="toggleBias(this)"><input type="checkbox"><label>ì§€ê¸ˆ ì´ íŒë‹¨ì´ ìµœê·¼ ë‰´ìŠ¤ì— ì˜í–¥ì„ ë°›ê³  ìˆëŠ”ê°€? (ìµœì‹ ì„± í¸í–¥)</label></div>
            <div class="bias-item" onclick="toggleBias(this)"><input type="checkbox"><label>ë‚´ê°€ ì›í•˜ëŠ” ê²°ë¡ ì„ ì§€ì§€í•˜ëŠ” ì •ë³´ë§Œ ì°¾ê³  ìˆì§€ ì•Šì€ê°€? (í™•ì¦í¸í–¥)</label></div>
            <div class="bias-item" onclick="toggleBias(this)"><input type="checkbox"><label>ì´ë¯¸ ë³´ìœ  ì¤‘ì´ë¼ì„œ íŒ”ê¸° ì‹«ì–´ì„œ ë³´ìœ í•˜ëŠ” ê±´ ì•„ë‹Œê°€? (ì†ì‹¤íšŒí”¼)</label></div>
            <div class="bias-item" onclick="toggleBias(this)"><input type="checkbox"><label>ë‹¤ë¥¸ ì‚¬ëŒì´ ë‹¤ ì‚¬ì„œ ë¶ˆì•ˆí•´ì„œ ë§¤ìˆ˜í•˜ë ¤ëŠ” ê±´ ì•„ë‹Œê°€? (êµ°ì§‘í–‰ë™)</label></div>
            <div class="bias-item" onclick="toggleBias(this)"><input type="checkbox"><label>ì²˜ìŒ ë“¤ì€ ê°€ê²©/ëª©í‘œê°€ì— ê¸°ì¤€ì ì´ ê³ ì •ë˜ì–´ ìˆì§€ ì•Šì€ê°€? (ì•µì»¤ë§)</label></div>
            <div class="bias-item" onclick="toggleBias(this)"><input type="checkbox"><label>ê³¼ê±° ìˆ˜ìµì´ ë‚¬ë‹¤ëŠ” ì´ìœ ë§Œìœ¼ë¡œ ì´ë²ˆì—ë„ ë  ê±°ë¼ ìƒê°í•˜ëŠ”ê°€? (ê³¼ì‹ í¸í–¥)</label></div>
            <div class="bias-item" onclick="toggleBias(this)"><input type="checkbox"><label>ì†ì‹¤ ë³¸ ê¸ˆì•¡ì„ ë³µêµ¬í•˜ë ¤ëŠ” ìƒê°ì´ ì˜ì‚¬ê²°ì •ì„ íë¦¬ê³  ìˆëŠ”ê°€? (ì‹¬ì íšŒê³„)</label></div>
            <div class="bias-item" onclick="toggleBias(this)"><input type="checkbox"><label>ì§€ê¸ˆ íŒ”ë©´ ì„¸ê¸ˆ/ìˆ˜ìˆ˜ë£Œê°€ ì•„ê¹Œì›Œì„œ ë³´ìœ í•˜ëŠ” ê±´ ì•„ë‹Œê°€? (í˜„ìƒìœ ì§€í¸í–¥)</label></div>
          </div>
          <div style="margin-top:12px;padding:10px;background:var(--bg3);border-radius:4px;font-size:12px;" id="bias-result">
            ì²´í¬ëœ í•­ëª©ì´ <strong>3ê°œ ì´ìƒ</strong>ì´ë©´ ë§¤ìˆ˜/ë§¤ë„ ê²°ì •ì„ í•˜ë£¨ ë¯¸ë£¨ì„¸ìš”.
          </div>
        </div>
      </div>
    </div>
  </div>

</div><!-- /main -->

<script>
const BACKEND = "https://andrew-backend-production.up.railway.app";

// â”€â”€ íƒ­ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('sec-' + name).classList.add('active');
  if (name === 'morning') loadMorning();
  if (name === 'closing') loadClosing();
  if (name === 'weekend') loadWeekend();
  if (name === 'dart') loadDartFull();
}

// â”€â”€ ì‹œê³„ & ìë™ íƒ­ í•˜ì´ë¼ì´íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClock() {
  const now = new Date();
  const h = now.getHours(), m = now.getMinutes();
  const pad = n => String(n).padStart(2,'0');
  const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  document.getElementById('clock').textContent =
    `${now.getFullYear()}.${pad(now.getMonth()+1)}.${pad(now.getDate())} (${days[now.getDay()]}) ${pad(h)}:${pad(m)}:${pad(now.getSeconds())}`;

  const isWeekend = now.getDay() === 0 || now.getDay() === 6;
  const isMorning = h >= 7 && h < 10;
  const isClosing = h >= 15 && h < 18;

  const mornTab = document.getElementById('tab-morning');
  const closTab = document.getElementById('tab-closing');
  const wkndTab = document.getElementById('tab-weekend');

  // ë±ƒì§€ í‘œì‹œ
  if (isMorning) { if (!mornTab.querySelector('.badge')) { const b=document.createElement('span'); b.className='badge'; b.textContent='LIVE'; mornTab.appendChild(b); } }
  else { const b=mornTab.querySelector('.badge'); if(b) b.remove(); }
  if (isClosing) { if (!closTab.querySelector('.badge')) { const b=document.createElement('span'); b.className='badge'; b.textContent='LIVE'; closTab.appendChild(b); } }
  else { const b=closTab.querySelector('.badge'); if(b) b.remove(); }
  if (isWeekend) { if (!wkndTab.querySelector('.badge')) { const b=document.createElement('span'); b.className='badge'; b.textContent='TODAY'; wkndTab.appendChild(b); } }
  else { const b=wkndTab.querySelector('.badge'); if(b) b.remove(); }
}
setInterval(updateClock, 1000); updateClock();

// â”€â”€ ë°±ì—”ë“œ ì—°ê²° ì²´í¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkStatus() {
  try {
    const r = await fetch(BACKEND + '/');
    const j = await r.json();
    if (j.status === 'running') {
      document.getElementById('status-dot').className = '';
      document.getElementById('status-dot').style.cssText = 'width:7px;height:7px;border-radius:50%;background:var(--green);display:inline-block;margin-right:6px;box-shadow:0 0 6px var(--green);animation:pulse 2s infinite;';
      document.getElementById('status-txt').textContent = 'ë°±ì—”ë“œ ì—°ê²°ë¨';
    }
  } catch {
    document.getElementById('status-dot').style.cssText = 'width:7px;height:7px;border-radius:50%;background:var(--red);display:inline-block;margin-right:6px;';
    document.getElementById('status-txt').textContent = 'ë°±ì—”ë“œ ì˜¤í”„ë¼ì¸';
  }
}

// â”€â”€ ìˆ«ì í¬ë§· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(v, decimals=2) {
  if (v === null || v === undefined) return 'â€”';
  return Number(v).toLocaleString('en-US', {minimumFractionDigits:decimals, maximumFractionDigits:decimals});
}
function setChg(elId, chg) {
  const el = document.getElementById(elId);
  if (!el) return;
  if (chg === null || chg === undefined) { el.textContent = 'â€”'; el.className = 'mkt-chg flat'; return; }
  const sign = chg >= 0 ? '+' : '';
  el.textContent = sign + chg.toFixed(2) + '%';
  el.className = 'mkt-chg ' + (chg > 0 ? 'up' : chg < 0 ? 'dn' : 'flat');
}
function setTickerChg(elId, chg) {
  const el = document.getElementById(elId);
  if (!el) return;
  if (chg === null || chg === undefined) { el.textContent = ''; return; }
  const sign = chg >= 0 ? 'â–²' : 'â–¼';
  el.textContent = sign + Math.abs(chg).toFixed(2) + '%';
  el.className = 'ticker-chg ' + (chg > 0 ? 'up' : chg < 0 ? 'dn' : 'flat');
}

// â”€â”€ ì‹œì¥ ë°ì´í„° ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMarket() {
  try {
    const r = await fetch(BACKEND + '/market/overview');
    const j = await r.json();
    const d = j.data;
    if (!d) return;
    document.getElementById('mkt-updated').textContent = 'ì—…ë°ì´íŠ¸: ' + new Date().toLocaleTimeString('ko-KR');

    // ëŒ€ì‹œë³´ë“œ
    const map = [
      ['sp500','m-sp500','m-sp500-c','tk-sp500','tk-sp500-chg',','],
      ['nasdaq','m-nasdaq','m-nasdaq-c','tk-nasdaq','tk-nasdaq-chg',','],
      ['dow','m-dow','m-dow-c',null,null,','],
      ['kospi','m-kospi','m-kospi-c','tk-kospi','tk-kospi-chg',','],
      ['kosdaq','m-kosdaq','m-kosdaq-c','tk-kosdaq','tk-kosdaq-chg',','],
      ['usdkrw','m-usdkrw','m-usdkrw-c','tk-usdkrw','tk-usdkrw-chg',','],
      ['usdkrw','m-usdkrw2','m-usdkrw2-c',null,null,','],
      ['usdjpy','m-usdjpy','m-usdjpy-c',null,null,','],
      ['us10y','m-us10y','m-us10y-c','tk-us10y','tk-us10y-chg',''],
      ['us2y','m-us2y','m-us2y-c',null,null,''],
      ['gold','m-gold','m-gold-c','tk-gold','tk-gold-chg',','],
      ['wti','m-wti','m-wti-c','tk-wti','tk-wti-chg',','],
      ['copper','m-copper','m-copper-c',null,null,','],
      ['silver','m-silver','m-silver-c','tk-silver','tk-silver-chg',','],
      ['vix','m-vix','m-vix-c','tk-vix','tk-vix-chg',''],
      ['vkospi','m-vkospi','m-vkospi-c',null,null,''],
    ];
    map.forEach(([key, valId, chgId, tkValId, tkChgId, sep]) => {
      const v = d[key]; if (!v) return;
      const el = document.getElementById(valId);
      if (el) el.textContent = v.price ? Number(v.price).toLocaleString('en-US', {minimumFractionDigits:2,maximumFractionDigits:2}) : 'â€”';
      setChg(chgId, v.change_pct);
      if (tkValId) {
        const tel = document.getElementById(tkValId);
        if (tel) tel.textContent = v.price ? Number(v.price).toLocaleString('en-US', {minimumFractionDigits:2,maximumFractionDigits:2}) : 'â€”';
      }
      if (tkChgId) setTickerChg(tkChgId, v.change_pct);
    });

    // ëª¨ë‹ / ë§ˆê° ê³µí†µ
    [
      ['sp500','mm-sp500','mm-sp500-c'],['nasdaq','mm-nasdaq','mm-nasdaq-c'],
      ['dow','mm-dow','mm-dow-c'],['usdkrw','mm-usdkrw','mm-usdkrw-c'],
      ['us10y','mm-us10y','mm-us10y-c'],['us2y','mm-us2y','mm-us2y-c'],
      ['gold','mm-gold','mm-gold-c'],['silver','mm-silver','mm-silver-c'],['wti','mm-wti','mm-wti-c'],['vix','mm-vix','mm-vix-c'],
      ['kospi','cl-kospi','cl-kospi-c'],['kosdaq','cl-kosdaq','cl-kosdaq-c'],
      ['usdkrw','cl-usdkrw','cl-usdkrw-c'],['usdjpy','cl-usdjpy','cl-usdjpy-c'],
    ].forEach(([key, valId, chgId]) => {
      const v = d[key]; if (!v) return;
      const el = document.getElementById(valId);
      if (el) el.textContent = v.price ? Number(v.price).toLocaleString('en-US', {minimumFractionDigits:2,maximumFractionDigits:2}) : 'â€”';
      setChg(chgId, v.change_pct);
    });
  } catch(e) { console.error(e); }
}

// â”€â”€ DART ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDartList(items, targetId) {
  const el = document.getElementById(targetId);
  if (!el) return;
  if (!items || !items.length) { el.innerHTML = '<div style="color:var(--text3);font-size:12px;padding:8px 0;">ê³µì‹œ ì—†ìŒ</div>'; return; }
  el.innerHTML = items.map(i => `
    <div class="dart-item">
      <span class="dart-company">${i.company}</span>
      <span class="dart-title"><a href="${i.url}" target="_blank">${i.title}</a></span>
      <span class="dart-date">${i.date ? i.date.replace(/(\d{4})(\d{2})(\d{2})/,'$1.$2.$3') : ''}</span>
      <span class="dart-badge ${i.type}">${i.type === 'major' ? 'ì£¼ìš”' : 'ì¼ë°˜'}</span>
    </div>
  `).join('');
}

async function loadDart(days=1) {
  try {
    const r = await fetch(BACKEND + '/dart/recent?days=' + days);
    const j = await r.json();
    renderDartList(j.data, 'dash-dart-list');
    renderDartList(j.data, 'morning-dart');
    renderDartList(j.data, 'closing-dart');
  } catch(e) {}
}

async function loadDartFull() {
  const days = document.getElementById('dart-days')?.value || 7;
  try {
    const r = await fetch(BACKEND + '/dart/recent?days=' + days);
    const j = await r.json();
    renderDartList(j.data, 'dart-full-list');
  } catch(e) {}
}

// â”€â”€ ë‰´ìŠ¤ ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNews(items, targetId, limit=8) {
  const el = document.getElementById(targetId);
  if (!el) return;
  if (!items || !items.length) { el.innerHTML = '<div style="color:var(--text3);font-size:12px;padding:8px 0;">ë‰´ìŠ¤ ì—†ìŒ</div>'; return; }
  el.innerHTML = items.slice(0, limit).map(n => `
    <div class="news-item" onclick="window.open('${n.link}','_blank')">
      <span class="news-source">${n.source}</span>
      <div class="news-content">
        <div class="news-title">${n.title}</div>
        ${n.desc ? '<div class="news-desc">' + n.desc + '</div>' : ''}
        <div class="news-date">${n.date || ''}</div>
      </div>
    </div>
  `).join('');
}

async function loadNews(targetId, limit) {
  try {
    const r = await fetch(BACKEND + '/news/rss');
    const j = await r.json();
    renderNews(j.data, targetId, limit);
    return j.data;
  } catch(e) { return []; }
}

// â”€â”€ ëª¨ë‹ ë¸Œë¦¬í•‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


async function loadDashboardAI(marketData, newsData) {
  const el = document.getElementById('dashboard-analysis');
  if (!el) return;
  const mkt = marketData || {};
  const fmt = (k) => { const v = mkt[k]; if (!v) return '-'; const p = Number(v.price).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); const c = v.change_pct != null ? (v.change_pct >= 0 ? '+' : '') + v.change_pct + '%' : ''; return `${p} (${c})`; };
  const mktSummary = `S&P500: ${fmt('sp500')}, ë‚˜ìŠ¤ë‹¥: ${fmt('nasdaq')}, ì½”ìŠ¤í”¼: ${fmt('kospi')}, ì½”ìŠ¤ë‹¥: ${fmt('kosdaq')}, USD/KRW: ${fmt('usdkrw')}, ë¯¸10ë…„ë¬¼: ${fmt('us10y')}%, VIX: ${fmt('vix')}, VKOSPI: ${fmt('vkospi')}, ê¸ˆ: ${fmt('gold')}, WTI: ${fmt('wti')}`;
  const newsSummary = (newsData||[]).slice(0,10).map(n=>`- [${n.source||''}] ${n.title}${n.content ? '\n  â”” '+n.content.slice(0,120) : ''}`).join('\n') || 'ì—†ìŒ';
  const prompt = `ë‹¹ì‹ ì€ Andrewì˜ ì „ë‹´ íˆ¬ì ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. AndrewëŠ” SNU ê²½ì˜í•™ê³¼ 2í•™ë…„ìœ¼ë¡œ ê¸€ë¡œë²Œ í—¤ì§€í€ë“œë¥¼ ëª©í‘œë¡œ í•˜ëŠ” íˆ¬ììì…ë‹ˆë‹¤. ë²„í• ê°€ì¹˜íˆ¬ì + í•˜ì›Œë“œ ë§‰ìŠ¤ ì‚¬ì´í´ + ì¹´ë„ˆë¨¼ í–‰ë™ê²½ì œí•™ ê¸°ë°˜ Draft 3.0 ì² í•™ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.

[ì‹¤ì‹œê°„ ì‹œì¥ ì§€í‘œ]
${mktSummary}

[ê¸€ë¡œë²Œ + í•œêµ­ ì£¼ìš” ë‰´ìŠ¤]
${newsSummary}

ì•„ë˜ 5ê°œ ì„¹ì…˜ìœ¼ë¡œ ì§€ê¸ˆ ì‹œì¥ ë¶„ì„ì„ í•´ì£¼ì„¸ìš” (í•œêµ­ì–´, ê° 3-4ë¬¸ì¥):

ğŸ“Š ì§€ê¸ˆ ì‹œì¥ â€” í˜„ì¬ ê¸€ë¡œë²ŒÂ·í•œêµ­ ì‹œì¥ì˜ í•µì‹¬ íë¦„. ì£¼ìš” ì§€ìˆ˜ ì›€ì§ì„ê³¼ ê·¸ ì˜ë¯¸ë¥¼ êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ í•¨ê»˜.

ğŸŒ ê¸€ë¡œë²Œ ë§¤í¬ë¡œ ì‹œê·¸ë„ â€” ê¸ˆë¦¬Â·ë‹¬ëŸ¬Â·ìœ ê°€Â·ê¸ˆ ë“± ë§¤í¬ë¡œ ì§€í‘œê°€ ë³´ë‚´ëŠ” ì‹ í˜¸. í•œêµ­ì‹œì¥ê³¼ì˜ ì—°ê´€ì„±.

ğŸ” ì˜¤ëŠ˜ì˜ í•µì‹¬ ì´ìŠˆ â€” ì‹œì¥ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ì´ìŠˆ 2ê°€ì§€ì™€ ìˆ˜í˜œ/í”¼í•´ ì„¹í„°.

âš ï¸ ë¦¬ìŠ¤í¬ ë ˆì´ë” â€” VIXÂ·VKOSPI ê¸°ì¤€ í˜„ì¬ ì„¼í‹°ë¨¼íŠ¸ êµ¬ê°„(ê³µí¬/íƒìš•/ì¤‘ë¦½). ìˆ¨ê²¨ì§„ ë¦¬ìŠ¤í¬ 1ê°€ì§€.

ğŸ’¡ Action Point â€” Draft 3.0 ê´€ì  í˜„ì¬ í¬ì§€ì…˜ íŒë‹¨(ë§¤ìˆ˜ ì ê·¹/ë¶„í• ë§¤ìˆ˜/ê´€ë§/íšŒí”¼)ê³¼ ì£¼ëª©í•  ì„¹í„°.`;
  try {
    el.innerHTML = '<div class="ai-loading"><div class="ai-dot"></div> AIê°€ ì‹œí™©ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”...</div>';
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 2000, messages: [{ role: 'user', content: prompt }] })
    });
    const data = await resp.json();
    const text = data.content?.[0]?.text || 'ë¶„ì„ ì‹¤íŒ¨';
    const formatted = text.replace(/^(ğŸ“Š|ğŸŒ|ğŸ”|âš ï¸|ğŸ’¡|ğŸ“…|ğŸ’°|ğŸ’¬)[^
]*/gm, m => `<span class="ai-label">${m}</span>`).replace(/
/g, '<br>');
    el.innerHTML = `<div class="ai-analysis-text">${formatted}</div>`;
  } catch(e) { el.innerHTML = '<div style="color:var(--text3);font-size:12px;">AI ë¶„ì„ ì‹¤íŒ¨: ' + e.message + '</div>'; }
}

function toggleAI(id) {
  const body = document.getElementById(id);
  const toggle = document.getElementById(id + '-toggle');
  if (!body) return;
  body.classList.toggle('collapsed');
  toggle.classList.toggle('open');
}

async function generateAIAnalysis(targetId, marketData, newsItems, dartItems, type) {
  const el = document.getElementById(targetId);
  if (!el) return;
  const mkt = marketData || {};
  const fmt = (k) => { const v = mkt[k]; if (!v) return '-'; const p = Number(v.price).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); const c = v.change_pct != null ? (v.change_pct >= 0 ? '+' : '') + v.change_pct + '%' : ''; return `${p} (${c})`; };
  const mktSummary = `S&P500: ${fmt('sp500')}, ë‚˜ìŠ¤ë‹¥: ${fmt('nasdaq')}, ì½”ìŠ¤í”¼: ${fmt('kospi')}, ì½”ìŠ¤ë‹¥: ${fmt('kosdaq')}, USD/KRW: ${fmt('usdkrw')}, ë¯¸10ë…„ë¬¼: ${fmt('us10y')}%, VIX: ${fmt('vix')}, VKOSPI: ${fmt('vkospi')}, ê¸ˆ: ${fmt('gold')}, ì€: ${fmt('silver')}, WTI: ${fmt('wti')}`;
  const newsSummary = (newsItems||[]).slice(0,8).map(n=>`- ${n.title}`).join('\n') || 'ì—†ìŒ';
  const dartSummary = (dartItems||[]).slice(0,5).map(d=>`- [${d.company}] ${d.title}`).join('\n') || 'ì—†ìŒ';
  const prompts = {
    morning: `ë‹¹ì‹ ì€ Andrewì˜ ì „ë‹´ íˆ¬ì ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. AndrewëŠ” SNU ê²½ì˜í•™ê³¼ 2í•™ë…„ìœ¼ë¡œ, ë²„í• ê°€ì¹˜íˆ¬ì + í•˜ì›Œë“œ ë§‰ìŠ¤ ì‚¬ì´í´ ì´ë¡  + ì¹´ë„ˆë¨¼ í–‰ë™ê²½ì œí•™ì„ ê²°í•©í•œ 'Draft 3.0' ì² í•™ì„ ê°€ì§„ íˆ¬ììì…ë‹ˆë‹¤. ì‹¤ì œ í—¤ì§€í€ë“œ ì• ë„ë¦¬ìŠ¤íŠ¸ ìˆ˜ì¤€ì˜ ë‚ ì¹´ë¡œìš´ ë¶„ì„ì„ ì›í•©ë‹ˆë‹¤.

[ì‹œì¥ ì§€í‘œ]
${mktSummary}

[ì£¼ìš” ë‰´ìŠ¤ â€” í•œêµ­ + ê¸€ë¡œë²Œ]
${newsSummary}

[ì£¼ìš” ê³µì‹œ]
${dartSummary}

ì•„ë˜ 6ê°œ ì„¹ì…˜ìœ¼ë¡œ ì•„ì¹¨ ë¸Œë¦¬í•‘ì„ ì‘ì„±í•´ì£¼ì„¸ìš” (í•œêµ­ì–´, ê° ì„¹ì…˜ 3-4ë¬¸ì¥):

ğŸ“Š ì‹œí™© í•œì¤„ ìš”ì•½ â€” ì˜¤ëŠ˜ ì‹œì¥ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ì •ì˜. ì–´ì œ ë¯¸ì¥ì˜ í•µì‹¬ ì›€ì§ì„ê³¼ ê·¸ ì˜ë¯¸ë¥¼ êµ¬ì²´ì  ìˆ˜ì¹˜ì™€ í•¨ê»˜ ì„¤ëª….

ğŸŒ ê¸€ë¡œë²Œ ë§¤í¬ë¡œ â€” ë¯¸êµ­ ê¸ˆë¦¬Â·ë‹¬ëŸ¬Â·êµ­ì œìœ ê°€Â·ê¸ˆ íë¦„ì´ ì˜¤ëŠ˜ í•œêµ­ì‹œì¥ì— ë¯¸ì¹  ì˜í–¥. íŠ¹íˆ ì›/ë‹¬ëŸ¬ í™˜ìœ¨ê³¼ ì™¸êµ­ì¸ ìˆ˜ê¸‰ ê´€ì ì—ì„œ ë¶„ì„.

ğŸ‡°ğŸ‡· í•œêµ­ì‹œì¥ ì „ë§ â€” ì½”ìŠ¤í”¼Â·ì½”ìŠ¤ë‹¥ ì˜ˆìƒ íë¦„. ì „ë‚  ADR(ë“±ë½ë¹„ìœ¨), ì£¼ë„ ì„¹í„°, í…Œë§ˆ íë¦„ ê´€ì ì—ì„œ ì˜¤ëŠ˜ ì£¼ëª©í•  ì›€ì§ì„.

ğŸ” í•µì‹¬ ì´ìŠˆ ë¶„ì„ â€” ì˜¤ëŠ˜ ê°€ì¥ ì¤‘ìš”í•œ ì´ìŠˆ 2ê°€ì§€ë¥¼ ê³¨ë¼ ê°ê° ì‹œì¥ ì„íŒ©íŠ¸ì™€ ìˆ˜í˜œÂ·í”¼í•´ ì„¹í„°ê¹Œì§€ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª….

âš ï¸ ë¦¬ìŠ¤í¬ & ì„¼í‹°ë¨¼íŠ¸ â€” VIX ${mkt.vix?.price || '-'} ê¸°ì¤€ í˜„ì¬ ì‹œì¥ ê³µí¬/íƒìš• êµ¬ê°„ íŒë‹¨. ì¡°ì‹¬í•´ì•¼ í•  ìˆ¨ê²¨ì§„ ë¦¬ìŠ¤í¬ 1ê°€ì§€.

ğŸ’¡ ì˜¤ëŠ˜ì˜ Action Point â€” Draft 3.0 ê´€ì ì—ì„œ ì˜¤ëŠ˜ ì·¨í•  í–‰ë™(ë§¤ìˆ˜ ì ê·¹/ë¶„í• ë§¤ìˆ˜/ê´€ë§/íšŒí”¼) íŒë‹¨ê³¼ êµ¬ì²´ì  ì£¼ëª© ì„¹í„°Â·ì¢…ëª© íŒíŠ¸.`,

    closing: `ë‹¹ì‹ ì€ Andrewì˜ ì „ë‹´ íˆ¬ì ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. Draft 3.0 ì² í•™(ë²„í• ê°€ì¹˜íˆ¬ì + í•˜ì›Œë“œ ë§‰ìŠ¤ ì‚¬ì´í´ + ì¹´ë„ˆë¨¼ í–‰ë™ê²½ì œí•™) ê¸°ë°˜ìœ¼ë¡œ ì˜¤ëŠ˜ ë§ˆê°ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.

[ë§ˆê° ì§€í‘œ]
${mktSummary}

[ì˜¤ëŠ˜ ë‰´ìŠ¤]
${newsSummary}

[ì˜¤ëŠ˜ ê³µì‹œ]
${dartSummary}

ì•„ë˜ 6ê°œ ì„¹ì…˜ìœ¼ë¡œ ë§ˆê° ë¸Œë¦¬í•‘ (í•œêµ­ì–´, ê° 3-4ë¬¸ì¥):

ğŸ“Š ì˜¤ëŠ˜ êµ­ì¥ ì´í‰ â€” ì½”ìŠ¤í”¼Â·ì½”ìŠ¤ë‹¥ ë§ˆê° ìˆ˜ì¹˜ì™€ ì˜ë¯¸. ì¥ì¤‘ íŠ¹ì´ íë¦„, ì£¼ë„/ë‚™ì˜¤ ì„¹í„° êµ¬ì²´ì ìœ¼ë¡œ.

ğŸ’° ìˆ˜ê¸‰ ë¶„ì„ â€” ì™¸êµ­ì¸Â·ê¸°ê´€Â·ê°œì¸ ìˆ˜ê¸‰ íë¦„ í•´ì„. ìˆœë§¤ìˆ˜ ìƒìœ„ ì—…ì¢…ê³¼ ê·¸ ì˜ë¯¸. í”„ë¡œê·¸ë¨ ë§¤ë§¤ ë™í–¥.

ğŸ” ì˜¤ëŠ˜ì˜ í•µì‹¬ ì´ìŠˆ â€” ì‹œì¥ì„ ì›€ì§ì¸ ì£¼ìš” ë‰´ìŠ¤Â·ì´ë²¤íŠ¸ 2ê°€ì§€ì™€ ê°ê°ì˜ ì‹œì¥ ì„íŒ©íŠ¸ ë¶„ì„.

ğŸŒ ë‚´ì¼Â·ì´ë²ˆì£¼ í¬ì¸íŠ¸ â€” ì˜¤ëŠ˜ íë¦„ì´ ë‚´ì¼ ë¯¸ì¥ ë° ì´ë²ˆ ì£¼ ë‚¨ì€ ì¼ì •ì— ì‹œì‚¬í•˜ëŠ” ì . ì˜ˆì •ëœ ê²½ì œì§€í‘œÂ·ì‹¤ì  ì²´í¬.

âš ï¸ ë¦¬ìŠ¤í¬ ë ˆì´ë” â€” ì˜¤ëŠ˜ ì‹œì¥ì—ì„œ ê°ì§€ëœ ì´ìƒ ì‹ í˜¸ë‚˜ ì£¼ì˜í•  ì . í•˜ì›Œë“œ ë§‰ìŠ¤ ê´€ì ì˜ ì‚¬ì´í´ ìœ„ì¹˜.

ğŸ’¡ ë‚´ì¼ ì „ëµ â€” Draft 3.0 ê¸°ì¤€ ë‚´ì¼ ì·¨í•  í¬ì§€ì…˜ê³¼ ì£¼ëª©í•  ì„¹í„°Â·ì¢…ëª©.`,

    weekend: `ë‹¹ì‹ ì€ Andrewì˜ ì „ë‹´ íˆ¬ì ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. ì´ë²ˆ ì£¼ ì‹œì¥ì„ ì´ê²°ì‚°í•˜ê³  ë‹¤ìŒ ì£¼ë¥¼ ì¤€ë¹„í•´ì£¼ì„¸ìš”.

[ì´ë²ˆ ì£¼ ì‹œì¥]
${mktSummary}

[ì´ë²ˆ ì£¼ ì£¼ìš” ë‰´ìŠ¤]
${newsSummary}

[ì£¼ìš” ê³µì‹œ]
${dartSummary}

ì•„ë˜ 7ê°œ ì„¹ì…˜ìœ¼ë¡œ ì£¼ê°„ ë¦¬í¬íŠ¸ (í•œêµ­ì–´, ê° 3-4ë¬¸ì¥):

ğŸ“Š ì´ë²ˆ ì£¼ ì‹œì¥ ì´í‰ â€” ì½”ìŠ¤í”¼Â·ì½”ìŠ¤ë‹¥Â·S&P500 ì£¼ê°„ ë“±ë½ë¥ ê³¼ ì˜ë¯¸. ì£¼ì¤‘ ê°€ì¥ ì¤‘ìš”í–ˆë˜ ë³€ê³¡ì .

ğŸŒ ê¸€ë¡œë²Œ ì´ìŠˆ ë¦¬ë·° â€” ì´ë²ˆ ì£¼ ê¸€ë¡œë²Œ ì‹œì¥ì„ ì›€ì§ì¸ í•µì‹¬ ë§¤í¬ë¡œ ì´ìŠˆ 2-3ê°€ì§€ì™€ ì‹œì¥ ë°˜ì‘.

ğŸ’° ì£¼ê°„ ìˆ˜ê¸‰ ë¦¬ë·° â€” ì´ë²ˆ ì£¼ ì™¸êµ­ì¸Â·ê¸°ê´€ ëˆ„ì  ìˆœë§¤ìˆ˜ íë¦„. ê°•ì„¸ ì—…ì¢…ê³¼ ì•½ì„¸ ì—…ì¢… êµ¬ë¶„.

ğŸ” ì´ë²ˆ ì£¼ ë² ìŠ¤íŠ¸ & ì›ŒìŠ¤íŠ¸ â€” ê°€ì¥ ì£¼ëª©í•  ë§Œí–ˆë˜ ì„¹í„°Â·ì¢…ëª©ê³¼ ê·¸ ì´ìœ . ì–´ë‹ ì„œí”„ë¼ì´ì¦ˆë‚˜ ê³µì‹œ ì´ìŠˆ í¬í•¨.

ğŸ“… ë‹¤ìŒ ì£¼ ìº˜ë¦°ë” â€” FOMCÂ·CPIÂ·ì‹¤ì  ë°œí‘œ ë“± ì£¼ìš” ì´ë²¤íŠ¸. í•œêµ­ ì‹œì¥ì— ì§ì ‘ ì˜í–¥ ì¤„ ì¼ì • ìš°ì„ .

âš ï¸ ë‹¤ìŒ ì£¼ ë¦¬ìŠ¤í¬ â€” í˜„ì¬ í•˜ì›Œë“œ ë§‰ìŠ¤ ì‚¬ì´í´ ê´€ì ì˜ ì‹œì¥ ìœ„ì¹˜. ì£¼ì˜í•´ì•¼ í•  í…Œì¼ ë¦¬ìŠ¤í¬.

ğŸ’¡ ì£¼ë§ ìˆ™ì œ & ë‹¤ìŒ ì£¼ ì „ëµ â€” Andrewê°€ ì£¼ë§ì— ê³µë¶€í•  ê²ƒ ì¶”ì²œ. Draft 3.0 ê¸°ì¤€ ë‹¤ìŒ ì£¼ í¬ì§€ì…˜ ë°©í–¥.`
  };
  try {
    el.innerHTML = '<div class="ai-loading"><div class="ai-dot"></div> AIê°€ ì‹œí™©ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”...</div>';
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 2000, messages: [{ role: 'user', content: prompts[type] }] })
    });
    const data = await resp.json();
    const text = data.content?.[0]?.text || 'ë¶„ì„ ì‹¤íŒ¨';
    const formatted = text.replace(/^(ğŸ“Š|ğŸ”|âš ï¸|ğŸŒ|ğŸ“…|ğŸ’¬)[^\n]*/gm, m => `<span class="ai-label">${m}</span>`).replace(/\n/g, '<br>');
    el.innerHTML = `<div class="ai-analysis-text">${formatted}</div>`;
  } catch(e) { el.innerHTML = '<div style="color:var(--text3);font-size:12px;">AI ë¶„ì„ ì‹¤íŒ¨: ' + e.message + '</div>'; }
}

async function loadMorning() {
  const now = new Date();
  document.getElementById('morning-time').textContent = now.toLocaleDateString('ko-KR', {year:'numeric',month:'long',day:'numeric',weekday:'long'});
  await loadMarket();
  const newsData = await loadNews('morning-news', 8);
  await loadDart(1);
  try { const mktJ = await (await fetch(BACKEND + '/market/overview')).json(); const dartJ = await (await fetch(BACKEND + '/dart/recent?days=1')).json(); generateAIAnalysis('morning-analysis', mktJ.data, newsData, dartJ.data, 'morning'); } catch(e) {}
}

// â”€â”€ ë§ˆê° ë¸Œë¦¬í•‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadClosing() {
  const now = new Date();
  document.getElementById('closing-time').textContent = now.toLocaleDateString('ko-KR', {year:'numeric',month:'long',day:'numeric',weekday:'long'});
  await loadMarket();
  const newsData = await loadNews('closing-news', 8);
  await loadDart(1);
  try { const mktJ = await (await fetch(BACKEND + '/market/overview')).json(); const dartJ = await (await fetch(BACKEND + '/dart/recent?days=1')).json(); generateAIAnalysis('closing-analysis', mktJ.data, newsData, dartJ.data, 'closing'); } catch(e) {}
}

// â”€â”€ ì£¼ë§ ë¸Œë¦¬í•‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadWeekend() {
  const now = new Date();
  document.getElementById('weekend-time').textContent = now.toLocaleDateString('ko-KR', {year:'numeric',month:'long',day:'numeric',weekday:'long'});
  const newsData = await loadNews('weekend-news', 12);
  const r = await fetch(BACKEND + '/dart/recent?days=7').catch(()=>({json:()=>({data:[]})}));
  const j = await r.json();
  renderDartList(j.data, 'weekend-dart');
  try { const mktJ = await (await fetch(BACKEND + '/market/overview')).json(); generateAIAnalysis('weekend-analysis', mktJ.data, newsData, j.data, 'weekend'); } catch(e) {}
}

// â”€â”€ ë°”ì´ì–´ìŠ¤ ì²´í¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleBias(el) {
  const cb = el.querySelector('input');
  cb.checked = !cb.checked;
  el.classList.toggle('checked', cb.checked);
  const total = document.querySelectorAll('.bias-item input:checked').length;
  const scoreEl = document.getElementById('bias-score-txt');
  scoreEl.textContent = total;
  scoreEl.className = 'bias-score ' + (total >= 5 ? 'danger' : total >= 3 ? 'caution' : 'safe');
  document.getElementById('bias-result').innerHTML = total >= 5
    ? '<strong style="color:var(--red)">âš ï¸ ìœ„í—˜:</strong> ì§€ê¸ˆ ë§¤ìˆ˜/ë§¤ë„ëŠ” ê°ì •ì  íŒë‹¨ì¼ ê°€ëŠ¥ì„±ì´ ë†’ì•„ìš”. ìµœì†Œ í•˜ë£¨ ì´ìƒ ê¸°ë‹¤ë¦¬ì„¸ìš”.'
    : total >= 3
    ? '<strong style="color:var(--yellow)">âš¡ ì£¼ì˜:</strong> ì¼ë¶€ í¸í–¥ì´ ê°ì§€ë©ë‹ˆë‹¤. ë°˜ë¡  3ê°œ ì´ìƒ ì •ë¦¬ í›„ ì¬ê²€í† í•˜ì„¸ìš”.'
    : '<strong style="color:var(--green)">âœ“ ì–‘í˜¸:</strong> ì²´í¬ëœ í•­ëª©ì´ ì ì–´ìš”. í•˜ì§€ë§Œ ë¹ ëœ¨ë¦° í•­ëª©ì´ ìˆëŠ”ì§€ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.';
}


// â”€â”€ ìŠ¤í¬ë¦¬ë„ˆ JS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let screenerCache = { kr: [], us: [] };
let chartInstances = {};

async function loadScreener(market, force = false) {
  const gridId = 'stock-grid-' + market;
  const statusId = market + '-status';
  const grid = document.getElementById(gridId);
  const status = document.getElementById(statusId);
  if (!grid) return;

  // ìºì‹œ ì—†ìœ¼ë©´ ë¡œë”© í‘œì‹œ
  if (!screenerCache[market].length) {
    grid.innerHTML = `
      <div style="grid-column:1/-1;padding:40px;text-align:center;color:var(--text2);">
        <div style="font-size:13px;margin-bottom:8px;">â³ ì„œë²„ì—ì„œ ìŠ¤í¬ë¦¬ë‹ ì¤‘...</div>
        <div style="font-size:11px;color:var(--text3);">
          ${market === 'kr' ? 'êµ­ì¥ ~55ê°œ' : 'ë¯¸ì¥ ~80ê°œ'} ì¢…ëª© Yahoo Finance ì‹¤ì‹œê°„ ìˆ˜ì§‘ ì¤‘
        </div>
        <div style="font-size:11px;color:var(--text3);margin-top:6px;">ì„œë²„ ì‹œì‘ ì‹œ ë°±ê·¸ë¼ìš´ë“œ ìë™ ì‹¤í–‰ë©ë‹ˆë‹¤ (1~3ë¶„)</div>
      </div>`;
  }
  if (status) status.textContent = 'ì„œë²„ì—ì„œ í™•ì¸ ì¤‘...';

  try {
    const url = BACKEND + '/screener/' + market + (force ? '?force=true' : '');
    const r = await fetch(url);
    const j = await r.json();

    // ì•ˆì „í•˜ê²Œ data ì¶”ì¶œ
    const data = Array.isArray(j.data) ? j.data : [];
    const isRunning = !!j.running;
    const phase = j.phase || '';

    if (data.length > 0) {
      // ë°ì´í„° ìˆìœ¼ë©´ ë°”ë¡œ í‘œì‹œ
      screenerCache[market] = data;
      renderScreenerCards(data, market);
      const updatedStr = j.updated ? new Date(j.updated).toLocaleString('ko-KR') : 'â€”';
      const mhIcon = j.market_hours ? 'ğŸŸ¢ ì¥ ì¤‘' : 'ğŸ”´ ì¥ ë§ˆê°';
      const runningStr = isRunning ? ' Â· â³ ì—…ë°ì´íŠ¸ ì¤‘' : '';
      if (status) status.textContent = `${data.length}ê°œ ì¢…ëª© Â· ${mhIcon} Â· ê°±ì‹ : ${updatedStr}${runningStr}`;
      return;
    }

    // ë°ì´í„° ì—†ìŒ â€” ì§„í–‰ ìƒíƒœ í‘œì‹œ
    const pct = (j.total > 0) ? Math.round(j.done / j.total * 100) : 0;
    const isError = phase && phase.startsWith('ì˜¤ë¥˜');
    const phaseIcon = isError ? 'âŒ' : isRunning ? 'â³' : 'â¸';
    const phaseColor = isError ? 'var(--red)' : 'var(--text2)';

    grid.innerHTML = `
      <div style="grid-column:1/-1;padding:40px;text-align:center;">
        <div style="font-size:13px;margin-bottom:12px;color:${phaseColor};">${phaseIcon} ${phase || (isRunning ? 'ìŠ¤í¬ë¦¬ë‹ ì¤‘...' : 'ëŒ€ê¸° ì¤‘')}</div>
        ${j.total > 0 ? `
        <div style="width:240px;margin:0 auto 8px;background:var(--bg3);border-radius:4px;height:6px;overflow:hidden;">
          <div style="width:${pct}%;height:100%;background:var(--accent);border-radius:4px;"></div>
        </div>
        <div style="font-size:11px;color:var(--text3);margin-bottom:12px;">${j.done} / ${j.total}ê°œ (${pct}%)</div>` :
        `<div style="font-size:11px;color:var(--text3);margin-bottom:12px;">
          ${isError ? 'ë°±ì—”ë“œ ì£¼ì†Œ: <code>https://andrew-backend-production.up.railway.app/screener/debug/' + market + '</code> í™•ì¸' : 'KRX + Yahoo Finance ìˆ˜ì§‘ ì¤‘...'}
        </div>`}
        <button onclick="loadScreener('${market}', true)" style="background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px 16px;border-radius:4px;cursor:pointer;font-size:11px;">
          ${isError ? 'ğŸ”„ ì¬ì‹œì‘' : 'ğŸ”„ ìƒíƒœ í™•ì¸'}
        </button>
      </div>`;

    if (status) status.textContent = `${phaseIcon} ${phase || 'ëŒ€ê¸° ì¤‘'}`;

    // ì—ëŸ¬ ì•„ë‹ˆë©´ ìë™ ì¬ì‹œë„
    if (!isError && isRunning) {
      setTimeout(() => loadScreener(market), 6000);
    } else if (!isError && !isRunning) {
      // ì•„ì§ ì‹œì‘ ì•ˆ ëœ ê²½ìš°
      setTimeout(() => loadScreener(market, true), 3000);
    }
  } catch(e) {
    console.error('Screener error:', e);
    if (grid) grid.innerHTML = `
      <div style="grid-column:1/-1;padding:20px;color:var(--red);font-size:12px;">
        âš ï¸ ì˜¤ë¥˜: ${e.message}<br>
        <button onclick="loadScreener('${market}')" style="margin-top:8px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:11px;">ì¬ì‹œë„</button>
      </div>`;
  }
}

function renderScreenerCards(stocks, market) {
  const gridId = 'stock-grid-' + market;
  const grid = document.getElementById(gridId);
  if (!grid) return;

  grid.innerHTML = stocks.map((s, i) => {
    const scoreClass = s.score >= 70 ? 'high' : s.score >= 50 ? 'mid' : 'low';
    const scoreColor = s.score >= 70 ? 'var(--green)' : s.score >= 50 ? 'var(--yellow)' : 'var(--red)';
    const priceStr = s.price
      ? (market === 'kr'
          ? s.price.toLocaleString('ko-KR') + 'ì›'
          : '$' + s.price.toLocaleString('en-US', {minimumFractionDigits:2,maximumFractionDigits:2}))
      : 'â€”';
    const chg = s.change_pct;
    const chgStr = chg !== null && chg !== undefined
      ? (chg >= 0 ? 'â–²' : 'â–¼') + Math.abs(chg).toFixed(2) + '%'
      : 'â€”';
    const chgClass = chg > 0 ? 'up' : chg < 0 ? 'dn' : 'flat';

    // ì§€í‘œ í‘œì‹œ
    const metrics = market === 'kr'
      ? [
          s.pbr != null ? `PBR ${s.pbr.toFixed(2)}x` : null,
          s.roe != null ? `ROE ${s.roe.toFixed(1)}%` : null,
          s.div_yield != null ? `ë°°ë‹¹ ${s.div_yield.toFixed(1)}%` : null,
          s.pe != null ? `PER ${s.pe.toFixed(1)}x` : null,
        ]
      : [
          s.peg != null ? `PEG ${s.peg.toFixed(2)}` : null,
          s.roe != null ? `ROE ${s.roe.toFixed(1)}%` : null,
          s.pe != null ? `PER ${s.pe.toFixed(1)}x` : null,
          s.fcf != null ? `FCF $${(s.fcf/1e9).toFixed(0)}B` : null,
        ];

    const rank = i + 1;
    const rankColor = rank <= 3 ? 'var(--gold)' : rank <= 7 ? 'var(--text2)' : 'var(--text3)';

    return `
    <div class="stock-card" onclick="selectScreenerStock('${s.ticker}', '${market}')">
      <div class="stock-header">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-family:var(--font-mono);font-size:12px;font-weight:700;color:${rankColor};">#${rank}</span>
          <div>
            <div class="stock-name">${s.name}</div>
            <div class="stock-ticker">${s.ticker}</div>
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-family:var(--font-mono);font-size:18px;font-weight:700;color:${scoreColor};">${s.score}</div>
          <div style="font-size:9px;color:var(--text3);">/ 100ì </div>
        </div>
      </div>
      <div class="stock-price-row">
        <div class="stock-price">${priceStr}</div>
        <div class="stock-chg ${chgClass}">${chgStr}</div>
      </div>
      <div class="match-bar-wrap">
        <div class="match-bar-label"><span>ğŸ“ ì² í•™ ë§¤ì¹­ ì ìˆ˜</span></div>
        <div class="match-bar-track"><div class="match-bar-fill ${scoreClass}" style="width:${s.score}%"></div></div>
      </div>
      <div class="stock-meta">
        ${metrics.filter(Boolean).map(m => `<div class="stock-meta-item">${m}</div>`).join('')}
      </div>
    </div>`;
  }).join('');
}


function renderPeerTable(s, market) {
  const tableId = 'peer-table-' + s.ticker.replace(/\./g,'_');
  const el = document.getElementById(tableId);
  if (!el) return;

  const cache = screenerCache[market] || [];
  const sector = s.sector || '';
  const industry = s.industry || '';

  // ê°™ì€ industry ìš°ì„ , ì—†ìœ¼ë©´ ê°™ì€ sector
  let peers = cache.filter(p => p.ticker !== s.ticker && p.industry && p.industry === industry);
  if (peers.length < 3) {
    peers = cache.filter(p => p.ticker !== s.ticker && p.sector && p.sector === sector);
  }
  // ìµœëŒ€ 6ê°œ, ì ìˆ˜ ìˆœ ì •ë ¬
  peers = peers.sort((a,b) => b.score - a.score).slice(0, 6);

  if (!peers.length) {
    el.innerHTML = '<div style="color:var(--text3);font-size:11px;">ê°™ì€ ì„¹í„° ì¢…ëª©ì´ ìŠ¤í¬ë¦¬ë„ˆì— ì—†ì–´ìš” (ì„¹í„°: ' + (sector||'ë¯¸ë¶„ë¥˜') + ')</div>';
    return;
  }

  // í˜„ì¬ ì¢…ëª© í¬í•¨í•´ì„œ ë¹„êµ
  const all = [s, ...peers].sort((a,b) => b.score - a.score);
  const isKr = market === 'kr';

  const fmtPrice = (p, cur) => cur === 'USD' ? '$' + Number(p).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}) : Number(p).toLocaleString('ko-KR') + 'ì›';
  const fmtPct = v => v != null ? (v >= 0 ? '+' : '') + v.toFixed(2) + '%' : 'â€”';
  const fmtX = v => v != null ? v.toFixed(2) + 'x' : 'â€”';
  const fmtPct1 = v => v != null ? v.toFixed(1) + '%' : 'â€”';

  const cols = isKr
    ? ['ì¢…ëª©', 'ì ìˆ˜', 'ì£¼ê°€', 'ë“±ë½', 'PBR', 'PER', 'ROE', 'ë°°ë‹¹']
    : ['ì¢…ëª©', 'ì ìˆ˜', 'ì£¼ê°€', 'ë“±ë½', 'PEG', 'PER', 'ROE', 'FCF'];

  const rows = all.map((p, i) => {
    const isSelf = p.ticker === s.ticker;
    const fcfStr = p.fcf ? (Math.abs(p.fcf)>=1e9 ? '$'+(p.fcf/1e9).toFixed(0)+'B' : '$'+(p.fcf/1e6).toFixed(0)+'M') : 'â€”';
    const cells = isKr
      ? [
          `<b>${p.name}</b><br><span style="font-size:9px;color:var(--text3);">${p.ticker}</span>`,
          `<span style="${isSelf?'':'color:var(--text2);'}">${p.score}</span>`,
          fmtPrice(p.price, p.currency),
          `<span style="color:${p.change_pct>0?'var(--green)':p.change_pct<0?'var(--red)':'var(--text2)'}">${fmtPct(p.change_pct)}</span>`,
          fmtX(p.pbr), fmtX(p.pe), fmtPct1(p.roe!=null?p.roe*100:null), fmtPct1(p.div_yield!=null?p.div_yield*100:null)
        ]
      : [
          `<b>${p.name}</b><br><span style="font-size:9px;color:var(--text3);">${p.ticker}</span>`,
          `<span style="${isSelf?'':'color:var(--text2);'}">${p.score}</span>`,
          fmtPrice(p.price, p.currency),
          `<span style="color:${p.change_pct>0?'var(--green)':p.change_pct<0?'var(--red)':'var(--text2)'}">${fmtPct(p.change_pct)}</span>`,
          fmtX(p.peg), fmtX(p.pe), fmtPct1(p.roe!=null?p.roe*100:null), fcfStr
        ];
    return `<tr class="${isSelf?'peer-self':''}">
      ${i===0?`<td><span class="peer-rank-1">ğŸ‘‘</span> ${cells[0]}</td>`:i===1?`<td>ğŸ¥ˆ ${cells[0]}</td>`:i===2?`<td>ğŸ¥‰ ${cells[0]}</td>`:`<td>${cells[0]}</td>`}
      ${cells.slice(1).map(c=>`<td>${c}</td>`).join('')}
    </tr>`;
  }).join('');

  el.innerHTML = `
    <div style="font-size:10px;color:var(--text3);margin-bottom:6px;">ì„¹í„°: <span style="color:var(--accent);">${industry || sector || 'ë¯¸ë¶„ë¥˜'}</span> Â· ${all.length}ê°œ ë¹„êµ</div>
    <table class="peer-table">
      <thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

function selectScreenerStock(ticker, market) {
  const s = screenerCache[market].find(x => x.ticker === ticker);
  if (!s) { console.error('stock not found:', ticker, market); return; }
  // ì´ì „ íŒ¨ë„ ë‹«ê¸°
  const prev = document.getElementById('detail-panel-' + market);
  if (prev) prev.style.display = 'none';
  renderScreenerDetail(s, market);
}

function renderScreenerDetail(s, market) {
  const panelId = 'detail-panel-' + market;
  let panel = document.getElementById(panelId);
  if (!panel) {
    // fallback: í˜„ì¬ í™œì„± ì„¹ì…˜ì— ë™ì ìœ¼ë¡œ íŒ¨ë„ ì‚½ì…
    const sec = document.getElementById('sec-' + market);
    if (!sec) { console.error('section not found:', market); return; }
    panel = document.createElement('div');
    panel.id = panelId;
    sec.appendChild(panel);
  }
  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

  const scoreColor = s.score >= 70 ? 'var(--green)' : s.score >= 50 ? 'var(--yellow)' : 'var(--red)';
  const verdict = s.score >= 75 ? 'âœ… ë§¤ìˆ˜ ì ê·¹ ê³ ë ¤' : s.score >= 60 ? 'âš¡ ì¶”ê°€ ì¡°ì‚¬ í•„ìš”' : 'âŒ í˜„ì¬ ê¸°ì¤€ ë¯¸ë‹¬';
  const verdictColor = s.score >= 75 ? 'var(--green)' : s.score >= 60 ? 'var(--yellow)' : 'var(--red)';

  // ì¬ë¬´ ì™¸ì  ì§€í‘œ
  const mktcapStr = s.mktcap
    ? (s.mktcap >= 1e12 ? '$' + (s.mktcap/1e12).toFixed(1) + 'T'
     : s.mktcap >= 1e9  ? '$' + (s.mktcap/1e9).toFixed(0) + 'B'
     : '$' + (s.mktcap/1e6).toFixed(0) + 'M')
    : 'â€”';
  const mktcapKrStr = s.mktcap && s.currency !== 'USD'
    ? (s.mktcap >= 1e12 ? (s.mktcap/1e12).toFixed(1) + 'ì¡°' : (s.mktcap/1e8).toFixed(0) + 'ì–µ')
    : null;
  const fcfStr = s.fcf
    ? (Math.abs(s.fcf) >= 1e12 ? (s.fcf/1e12).toFixed(1)+'T'
     : Math.abs(s.fcf) >= 1e9  ? (s.fcf/1e9).toFixed(0)+'B'
     : (s.fcf/1e6).toFixed(0)+'M')
    : null;

  const extraMetrics = [
    { label: 'ì‹œê°€ì´ì•¡',   val: mktcapKrStr || mktcapStr },
    { label: 'ë² íƒ€(Î²)',    val: s.beta != null ? s.beta.toFixed(2) : null },
    { label: 'ë¶€ì±„/ìë³¸',  val: s.debt_equity != null ? s.debt_equity.toFixed(0)+'%' : null },
    { label: 'ìœ ë™ë¹„ìœ¨',   val: s.cur_ratio != null ? s.cur_ratio.toFixed(2) : null },
    { label: 'ì˜ì—…ì´ìµë¥ ', val: s.op_margin != null ? s.op_margin.toFixed(1)+'%' : null },
    { label: 'ë§¤ì¶œì„±ì¥',   val: s.rev_growth != null ? (s.rev_growth > 0 ? '+' : '') + s.rev_growth.toFixed(1)+'%' : null },
    { label: 'FCF',        val: fcfStr ? (s.currency==='USD'?'$':'')+fcfStr : null },
    { label: 'Fwd PER',    val: s.fwd_pe != null ? s.fwd_pe.toFixed(1)+'x' : null },
  ].filter(m => m.val);

  panel.innerHTML = `
    <div class="detail-panel">
      <!-- í—¤ë” -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
        <div>
          <span style="font-size:18px;font-weight:600;color:var(--text);">${s.name}</span>
          <span style="font-family:var(--font-mono);font-size:12px;color:var(--text3);margin-left:8px;">${s.ticker}</span>
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
          <div style="text-align:right;">
            <div style="font-family:var(--font-mono);font-size:26px;font-weight:700;color:${scoreColor};">${s.score}<span style="font-size:12px;color:var(--text3);">/100</span></div>
            <div style="font-size:10px;color:var(--text3);">ì² í•™ ë§¤ì¹­ ì ìˆ˜</div>
          </div>
          <button onclick="document.getElementById('detail-panel-${market}').style.display='none';"
            style="background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:5px 12px;border-radius:4px;cursor:pointer;font-size:11px;">âœ•</button>
        </div>
      </div>

      <!-- ì´í‰ -->
      <div style="margin-bottom:14px;padding:10px 14px;background:var(--bg3);border-radius:5px;border-left:3px solid ${verdictColor};">
        <div style="font-size:12px;font-weight:600;color:${verdictColor};margin-bottom:4px;">${verdict}</div>
        <div style="font-size:11px;color:var(--text2);">${s.summary || ''}</div>
      </div>

      <!-- ì ìˆ˜ ì§„í–‰ë°” -->
      <div style="margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text3);margin-bottom:4px;">
          <span>0</span><span>25</span><span>50</span><span>75</span><span>100</span>
        </div>
        <div style="background:var(--bg3);border-radius:4px;height:8px;position:relative;">
          <div style="width:${s.score}%;height:100%;background:${scoreColor};border-radius:4px;transition:width .5s;"></div>
          <div style="position:absolute;top:0;left:25%;width:1px;height:100%;background:var(--border);"></div>
          <div style="position:absolute;top:0;left:50%;width:1px;height:100%;background:var(--border);"></div>
          <div style="position:absolute;top:0;left:75%;width:1px;height:100%;background:var(--border);"></div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
        <!-- ì±„ì  ìƒì„¸ -->
        <div>
          <div style="font-size:10px;font-weight:600;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">ğŸ“ ì±„ì  ìƒì„¸</div>
          ${(s.criteria || []).map(c => `
            <div style="display:flex;gap:8px;align-items:flex-start;padding:5px 0;border-bottom:1px solid var(--bg3);">
              <span style="font-size:12px;flex-shrink:0;color:${c.pass==='pass'?'var(--green)':c.pass==='warn'?'var(--yellow)':'var(--red)'};">${c.pass==='pass'?'âœ“':c.pass==='warn'?'â–³':'âœ•'}</span>
              <div style="flex:1;min-width:0;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <span style="font-size:11px;color:var(--text);">${c.key}</span>
                  <span style="font-family:var(--font-mono);font-size:11px;font-weight:600;color:${c.pass==='pass'?'var(--green)':c.pass==='warn'?'var(--yellow)':'var(--red)'};">${c.val}</span>
                </div>
                <div style="font-size:10px;color:var(--text3);margin-top:1px;">${c.note}</div>
              </div>
            </div>
          `).join('')}
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì°¨íŠ¸ + ì¬ë¬´ ì™¸ì  ì§€í‘œ -->
        <div>
          <div style="font-size:10px;font-weight:600;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">ğŸ“ˆ ìµœê·¼ 7ì¼</div>
          <!-- ê¸°ê°„ ì„ íƒ ë²„íŠ¼ -->
          <div style="display:flex;gap:4px;margin-bottom:8px;">
            ${['1D','1W','1M','3M','6M','1Y'].map(p => `
              <button onclick="loadDetailChart('${s.ticker}','${market}','${p}')"
                id="chart-btn-${p}-${s.ticker.replace(/\./g,'_')}"
                style="flex:1;padding:3px 0;background:${p==='1M'?'var(--accent)':'var(--bg3)'};border:1px solid var(--border);
                       color:${p==='1M'?'#fff':'var(--text3)'};border-radius:3px;cursor:pointer;font-size:10px;font-family:var(--font-mono);"
              >${p}</button>
            `).join('')}
          </div>
          <!-- ì°¨íŠ¸ ê°€ê²© ì •ë³´ -->
          <div id="chart-info-${s.ticker.replace(/\./g,'_')}"
               style="font-size:11px;color:var(--text3);margin-bottom:4px;height:16px;"></div>
          <!-- ìº”ë“¤ ìº”ë²„ìŠ¤ -->
          <canvas id="screener-chart-${s.ticker.replace(/\./g,'_')}" height="120"
                  style="cursor:crosshair;"
                  onmousemove="chartMouseMove(event, '${s.ticker}')"
                  onmouseleave="chartMouseLeave('${s.ticker}')"></canvas>
          <!-- ë³¼ë¥¨ -->
          <canvas id="chart-vol-${s.ticker.replace(/\./g,'_')}" height="28"></canvas>

          <div style="margin-top:12px;">
            <div style="font-size:10px;font-weight:600;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">ğŸ” ì¬ë¬´ ì™¸ì  ì§€í‘œ</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;">
              ${extraMetrics.map(m => `
                <div style="background:var(--bg3);border-radius:4px;padding:6px 8px;">
                  <div style="font-size:9px;color:var(--text3);">${m.label}</div>
                  <div style="font-family:var(--font-mono);font-size:12px;font-weight:600;color:var(--text);">${m.val}</div>
                </div>
              `).join('')}
              ${extraMetrics.length === 0 ? '<div style="color:var(--text3);font-size:11px;grid-column:1/-1;">ë°ì´í„° ì—†ìŒ</div>' : ''}
            </div>
          </div>
        </div>
      </div>
      <!-- ë™ì¢… ê¸°ì—… ë¹„êµ -->
      <div style="margin-top:16px;">
        <div style="font-size:10px;font-weight:600;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;">ğŸ¢ ë™ì¢… ê¸°ì—… ë¹„êµ</div>
        <div id="peer-table-${s.ticker.replace(/\./g,'_')}">
          <div style="color:var(--text3);font-size:11px;">ë¡œë”© ì¤‘...</div>
        </div>
      </div>
    </div>`;

  // ì°¨íŠ¸ ë¡œë“œ
  setTimeout(() => loadDetailChart(s.ticker, market, '1M'), 50);
}

// â”€â”€ ì°¨íŠ¸ ì „ì—­ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const chartData = {};   // ticker â†’ {candles, range}
const chartHover = {};  // ticker â†’ hoverIdx

async function loadDetailChart(ticker, market, period) {
  const rangeMap = { '1D':'1d','1W':'5d','1M':'1mo','3M':'3mo','6M':'6mo','1Y':'1y' };
  const intMap   = { '1D':'5m','1W':'1h','1M':'1d','3M':'1d','6M':'1d','1Y':'1wk' };
  const range    = rangeMap[period] || '1mo';
  const interval = intMap[period]   || '1d';
  const safeId   = ticker.replace(/\./g,'_');

  // ë²„íŠ¼ í™œì„±í™”
  ['1D','1W','1M','3M','6M','1Y'].forEach(p => {
    const btn = document.getElementById(`chart-btn-${p}-${safeId}`);
    if (btn) {
      btn.style.background = p === period ? 'var(--accent)' : 'var(--bg3)';
      btn.style.color      = p === period ? '#fff' : 'var(--text3)';
    }
  });

  try {
    const r = await fetch(BACKEND + `/chart/${encodeURIComponent(ticker)}?range=${range}&interval=${interval}`);
    const j = await r.json();
    if (j.status !== 'ok' || !j.candles?.length) return;
    chartData[ticker] = { candles: j.candles, range: period, price: j.price, prev: j.prev };
    drawProChart(ticker);
  } catch(e) { console.error('chart load error:', e); }
}

function drawProChart(ticker) {
  const safeId  = ticker.replace(/\./g,'_');
  const canvas  = document.getElementById('screener-chart-' + safeId);
  const volCvs  = document.getElementById('chart-vol-' + safeId);
  if (!canvas) return;
  const data    = chartData[ticker];
  if (!data?.candles?.length) return;
  const candles = data.candles;

  // â”€â”€ ìº”ë“¤ ìº”ë²„ìŠ¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const dpr  = window.devicePixelRatio || 1;
  const W    = canvas.parentElement.clientWidth || 320;
  const H    = parseInt(canvas.getAttribute('height')) || 120;
  canvas.width  = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W+'px'; canvas.style.height = H+'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  const pad = { t:8, b:20, l:10, r:50 };
  const cw  = W - pad.l - pad.r;
  const ch  = H - pad.t - pad.b;

  // ê°€ê²© ë²”ìœ„
  const highs = candles.map(c=>c.high), lows = candles.map(c=>c.low);
  const maxP  = Math.max(...highs), minP = Math.min(...lows);
  const range = (maxP - minP) || maxP * 0.01 || 1;
  const toY   = p => pad.t + ch * (1 - (p - minP) / range);

  // ë°°ê²½ ê·¸ë¦¬ë“œ
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.t + ch * i / 4;
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l+cw, y); ctx.stroke();
    const price = maxP - (range * i / 4);
    ctx.fillStyle = 'rgba(255,255,255,0.4)';
    ctx.font = '9px monospace'; ctx.textAlign = 'left';
    ctx.fillText(price >= 1000 ? price.toLocaleString('ko-KR') : price.toFixed(2), pad.l+cw+3, y+3);
  }

  const n    = candles.length;
  const cw2  = cw / n;
  const bw   = Math.max(1.5, Math.min(cw2 * 0.65, 12));

  // ì´ë™í‰ê· ì„  (MA5, MA20)
  const drawMA = (period, color) => {
    ctx.strokeStyle = color; ctx.lineWidth = 1; ctx.setLineDash([]);
    ctx.beginPath();
    let started = false;
    for (let i = period-1; i < n; i++) {
      const avg = candles.slice(i-period+1, i+1).reduce((s,c)=>s+c.close,0)/period;
      const x = pad.l + (i + 0.5) * cw2;
      if (!started) { ctx.moveTo(x, toY(avg)); started=true; }
      else ctx.lineTo(x, toY(avg));
    }
    ctx.stroke();
  };
  if (n >= 5)  drawMA(5,  'rgba(255,200,0,0.6)');
  if (n >= 20) drawMA(20, 'rgba(100,180,255,0.6)');

  // ìº”ë“¤
  candles.forEach((c, i) => {
    const x    = pad.l + (i + 0.5) * cw2;
    const isUp = c.close >= c.open;
    const col  = isUp ? '#26a69a' : '#ef5350';

    // ì‹¬ì§€
    ctx.strokeStyle = col; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(x, toY(c.high)); ctx.lineTo(x, toY(c.low)); ctx.stroke();

    // ëª¸í†µ
    const y1 = toY(Math.max(c.open, c.close));
    const y2 = toY(Math.min(c.open, c.close));
    const bh = Math.max(1, y2 - y1);
    ctx.fillStyle = col;
    ctx.fillRect(x - bw/2, y1, bw, bh);

    // Xì¶• ë‚ ì§œ (ì¼ë¶€ë§Œ)
    const step = Math.ceil(n / 6);
    if (i % step === 0) {
      ctx.fillStyle = 'rgba(255,255,255,0.35)';
      ctx.font = '8px monospace'; ctx.textAlign = 'center';
      ctx.fillText(c.date, x, H - 5);
    }
  });

  // ë§ˆì§€ë§‰ ê°€ê²© ë¼ì¸
  if (candles.length) {
    const lastY = toY(candles[candles.length-1].close);
    const isUp  = candles[candles.length-1].close >= (data.prev || candles[0].close);
    ctx.strokeStyle = isUp ? '#26a69a' : '#ef5350';
    ctx.lineWidth = 1; ctx.setLineDash([3,3]);
    ctx.beginPath(); ctx.moveTo(pad.l, lastY); ctx.lineTo(pad.l+cw, lastY); ctx.stroke();
    ctx.setLineDash([]);
  }

  // â”€â”€ ë³¼ë¥¨ ìº”ë²„ìŠ¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (volCvs) {
    const VH = parseInt(volCvs.getAttribute('height')) || 28;
    volCvs.width = W * dpr; volCvs.height = VH * dpr;
    volCvs.style.width = W+'px'; volCvs.style.height = VH+'px';
    const vctx = volCvs.getContext('2d'); vctx.scale(dpr, dpr);
    const maxV = Math.max(...candles.map(c=>c.volume||0)) || 1;
    candles.forEach((c, i) => {
      const x  = pad.l + (i + 0.5) * cw2;
      const vh = ((c.volume||0) / maxV) * (VH - 4);
      vctx.fillStyle = c.close >= c.open ? 'rgba(38,166,154,0.5)' : 'rgba(239,83,80,0.5)';
      vctx.fillRect(x - bw/2, VH - vh - 2, bw, vh);
    });
  }

  // ë²”ë¡€
  ctx.font = '8px monospace'; ctx.textAlign = 'left';
  ctx.fillStyle = 'rgba(255,200,0,0.8)'; ctx.fillText('MA5',  pad.l+2, pad.t+10);
  ctx.fillStyle = 'rgba(100,180,255,0.8)'; ctx.fillText('MA20', pad.l+28, pad.t+10);
}

function chartMouseMove(e, ticker) {
  const safeId = ticker.replace(/\./g,'_');
  const canvas = document.getElementById('screener-chart-' + safeId);
  const info   = document.getElementById('chart-info-' + safeId);
  if (!canvas || !info || !chartData[ticker]) return;
  const data    = chartData[ticker];
  const candles = data.candles;
  const rect    = canvas.getBoundingClientRect();
  const x       = e.clientX - rect.left;
  const W       = rect.width;
  const pad_l   = 10, pad_r = 50;
  const cw      = W - pad_l - pad_r;
  const idx     = Math.max(0, Math.min(candles.length-1, Math.floor((x - pad_l) / cw * candles.length)));
  const c       = candles[idx];
  if (!c) return;
  const isCurrency = ticker.endsWith('.KS') || ticker.endsWith('.KQ');
  const fmt = v => isCurrency ? v.toLocaleString('ko-KR') + 'ì›' : '$' + v.toFixed(2);
  const chgPct = ((c.close - c.open) / c.open * 100).toFixed(2);
  const col = c.close >= c.open ? '#26a69a' : '#ef5350';
  info.innerHTML = `<span style="color:var(--text2);">${c.date}</span>
    <span style="margin-left:8px;">ì‹œ <b style="color:${col}">${fmt(c.open)}</b></span>
    <span style="margin-left:6px;">ê³  <b style="color:#26a69a">${fmt(c.high)}</b></span>
    <span style="margin-left:6px;">ì € <b style="color:#ef5350">${fmt(c.low)}</b></span>
    <span style="margin-left:6px;">ì¢… <b style="color:${col}">${fmt(c.close)}</b></span>
    <span style="margin-left:6px;color:${col};">${chgPct >= 0 ? '+' : ''}${chgPct}%</span>`;
}

function chartMouseLeave(ticker) {
  const safeId = ticker.replace(/\./g,'_');
  const info   = document.getElementById('chart-info-' + safeId);
  if (info) info.innerHTML = '';
}

function drawCandleChart(canvas, hist) {
  // legacy fallback â€” íˆìŠ¤í† ë¦¬ ë°ì´í„°ë¡œ ë‹¨ìˆœ ìº”ë“¤
  chartData['__legacy__'] = { candles: hist, range: '1W' };
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.parentElement.clientWidth || 300;
  const H = parseInt(canvas.getAttribute('height')) || 100;
  canvas.width = W*dpr; canvas.height = H*dpr;
  canvas.style.width = W+'px'; canvas.style.height = H+'px';
  ctx.scale(dpr, dpr);
  const pad = {t:8,b:20,l:10,r:50};
  const cw = W-pad.l-pad.r, ch = H-pad.t-pad.b;
  const maxP = Math.max(...hist.map(h=>h.high||h.close));
  const minP = Math.min(...hist.map(h=>h.low||h.close));
  const range = (maxP-minP)||1;
  const toY = p => pad.t + ch*(1-(p-minP)/range);
  const n = hist.length, cw2 = cw/n, bw = Math.max(2, cw2*0.6);
  hist.forEach((h,i) => {
    const x = pad.l+(i+0.5)*cw2;
    const isUp = h.close >= (h.open||h.close);
    const col = isUp ? '#26a69a' : '#ef5350';
    ctx.strokeStyle = col; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(x,toY(h.high||h.close)); ctx.lineTo(x,toY(h.low||h.close)); ctx.stroke();
    const y1=toY(Math.max(h.open||h.close,h.close)), y2=toY(Math.min(h.open||h.close,h.close));
    ctx.fillStyle=col; ctx.fillRect(x-bw/2,y1,bw,Math.max(1,y2-y1));
    ctx.fillStyle='rgba(255,255,255,0.35)'; ctx.font='8px monospace'; ctx.textAlign='center';
    ctx.fillText(h.date, x, H-5);
  });
}

function drawScreenerChart(s) {
  if (!s || !s.history || s.history.length === 0) return;
  const canvasId = 'chart-' + s.ticker.replace(/\./g, '_');
  const canvas = document.getElementById(canvasId);
  if (canvas) drawCandleChart(canvas, s.history);
}

function drawCandleChart(canvas, hist) {
  const dpr  = window.devicePixelRatio || 1;
  const W    = canvas.parentElement.clientWidth || 300;
  const H    = parseInt(canvas.getAttribute('height')) || 100;
  canvas.width  = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width  = W + 'px';
  canvas.style.height = H + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  const pad = { t:10, b:24, l:8, r:8 };
  const cw  = W - pad.l - pad.r;
  const ch  = H - pad.t - pad.b;

  // ê°€ê²© ë²”ìœ„
  const allPrices = hist.flatMap(h => [h.high, h.low]);
  const minP = Math.min(...allPrices);
  const maxP = Math.max(...allPrices);
  const range = maxP - minP || 1;
  const toY = p => pad.t + ch * (1 - (p - minP) / range);

  const n    = hist.length;
  const cw2  = cw / n;
  const bw   = Math.max(2, cw2 * 0.55);

  // Yì¶• ë¼ë²¨ (ê³ ê°€/ì €ê°€)
  ctx.font = '9px monospace';
  ctx.fillStyle = 'rgba(255,255,255,0.3)';
  ctx.textAlign = 'right';
  ctx.fillText(maxP.toLocaleString(), pad.l + cw + 6, pad.t + 8);
  ctx.fillText(minP.toLocaleString(), pad.l + cw + 6, pad.t + ch);

  hist.forEach((h, i) => {
    const x    = pad.l + (i + 0.5) * cw2;
    const isUp = h.close >= h.open;
    const col  = isUp ? '#26a69a' : '#ef5350';

    // ì‹¬ì§€ (high-low)
    ctx.strokeStyle = col;
    ctx.lineWidth   = 1;
    ctx.beginPath();
    ctx.moveTo(x, toY(h.high));
    ctx.lineTo(x, toY(h.low));
    ctx.stroke();

    // ëª¸í†µ (open-close)
    const y1 = toY(Math.max(h.open, h.close));
    const y2 = toY(Math.min(h.open, h.close));
    const bh = Math.max(1, y2 - y1);
    ctx.fillStyle = col;
    ctx.fillRect(x - bw/2, y1, bw, bh);

    // Xì¶• ë‚ ì§œ
    ctx.fillStyle = 'rgba(255,255,255,0.4)';
    ctx.textAlign = 'center';
    ctx.font = '8px monospace';
    ctx.fillText(h.date, x, H - 6);
  });
}

function drawScreenerChart(s) {
  const canvasId = 'screener-chart-' + s.ticker.replace(/\./g,'_');
  const ctx = document.getElementById(canvasId);
  if (!ctx) return;
  const key = 'sc_' + s.ticker;
  if (chartInstances[key]) chartInstances[key].destroy();

  const hist = (s.history && s.history.length) ? s.history : [];
  if (!hist.length) {
    ctx.parentElement.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text3);font-size:11px;">ì°¨íŠ¸ ë°ì´í„° ì—†ìŒ</div>';
    return;
  }

  // OHLCV ìº”ë“¤ì°¨íŠ¸ (Chart.js ì»¤ìŠ¤í…€)
  const hasCandleData = hist[0].open !== undefined;
  const labels = hist.map(h => h.date);
  const prices = hist.map(h => h.close);
  const isUp = prices.length > 1 && prices[prices.length-1] >= prices[0];

  if (hasCandleData) {
    // ìº”ë“¤ì°¨íŠ¸ ì§ì ‘ ê·¸ë¦¬ê¸° (Canvas API)
    drawCandleChart(ctx, hist);
    return;
  }

  chartInstances[key] = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        data: prices,
        borderColor: isUp ? '#3fb950' : '#f85149',
        backgroundColor: isUp ? 'rgba(63,185,80,0.05)' : 'rgba(248,81,73,0.05)',
        tension: 0.3, fill: true, pointRadius: 3,
        pointBackgroundColor: isUp ? '#3fb950' : '#f85149',
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: '#1e2a35' }, ticks: { color: '#8b949e', font: { family: 'IBM Plex Mono', size: 10 } } },
        y: { grid: { color: '#1e2a35' }, ticks: { color: '#8b949e', font: { family: 'IBM Plex Mono', size: 10 } } }
      }
    }
  });
}

// switchTabì— êµ­ì¥/ë¯¸ì¥ ìŠ¤í¬ë¦¬ë„ˆ ì—°ê²°
const _origSwitchTab = switchTab;
switchTab = function(name, el) {
  _origSwitchTab(name, el);
  if (name === 'kr') {
    if (screenerCache.kr.length === 0) loadScreener('kr');
    else { renderScreenerCards(screenerCache.kr, 'kr'); loadScreener('kr'); }
  }
  if (name === 'us') {
    if (screenerCache.us.length === 0) loadScreener('us');
    else { renderScreenerCards(screenerCache.us, 'us'); loadScreener('us'); }
  }
};

(async function init() {
  checkStatus();
  await loadMarket();
  await loadDart(7);
  try {
    const [mktJ, newsJ] = await Promise.all([
      fetch(BACKEND + '/market/overview').then(r=>r.json()),
      fetch(BACKEND + '/news/rss').then(r=>r.json())
    ]);
    loadDashboardAI(mktJ.data, newsJ.data);
  } catch(e) {}
  setInterval(loadMarket, 60000);
  setInterval(checkStatus, 30000);
})();
</script>
<script>if("serviceWorker"in navigator){window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js");});}</script>
</body>
</html>
